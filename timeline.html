<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PKD Timeline View</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1b;
            --bg-card: #232326;
            --bg-hover: #2a2a2d;
            --text-primary: #e8e8e9;
            --text-secondary: #9ca3af;
            --border-color: #333336;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            --pastel-green: #86efac;
            --pastel-red: #fca5a5;
            --pastel-blue: #93c5fd;
            --pastel-purple: #c4b5fd;
            --pastel-orange: #fcd34d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--pastel-blue), var(--pastel-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            background: var(--pastel-blue);
            border: none;
            border-radius: 8px;
            color: var(--bg-primary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .timeline-controls {
            padding: 1.5rem 2rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        select, input[type="month"] {
            padding: 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .timeline-container {
            padding: 2rem;
            overflow-x: auto;
            overflow-y: auto;
            height: calc(100vh - 200px);
        }

        .timeline-grid {
            display: inline-block;
            min-width: 100%;
        }

        .timeline-header {
            display: grid;
            grid-template-columns: 250px repeat(var(--month-count, 12), 120px);
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            z-index: 50;
        }

        .header-cell {
            padding: 1rem;
            text-align: center;
            border-right: 1px solid var(--border-color);
            font-size: 0.875rem;
            font-weight: 600;
        }

        .header-cell.project-label {
            text-align: left;
            background: var(--bg-card);
        }

        .month-header {
            background: var(--bg-secondary);
            position: relative;
        }

        .month-header.quarter-start {
            border-left: 2px solid var(--pastel-blue);
        }

        .timeline-body {
            display: grid;
            grid-template-columns: 250px repeat(var(--month-count, 12), 120px);
        }

        .timeline-row {
            display: contents;
        }

        .project-info-cell {
            padding: 1rem;
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-card);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            cursor: grab;
        }

        .project-info-cell:active {
            cursor: grabbing;
        }

        .project-name {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .project-users {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }

        .user-badge {
            padding: 0.125rem 0.5rem;
            background: var(--pastel-purple);
            color: var(--bg-primary);
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .timeline-cell {
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            position: relative;
            background: var(--bg-secondary);
            min-height: 60px;
        }

        .timeline-cell.quarter-start {
            border-left: 2px solid var(--pastel-blue);
        }

        .timeline-bar {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            height: 40px;
            background: var(--pastel-blue);
            border-radius: 6px;
            cursor: move;
            display: flex;
            align-items: center;
            padding: 0 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--bg-primary);
            transition: box-shadow 0.2s;
            user-select: none;
        }

        .timeline-bar:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            z-index: 10;
        }

        .timeline-bar.dragging {
            opacity: 0.7;
            z-index: 20;
        }

        .timeline-bar.status-moving {
            background: var(--pastel-green);
        }

        .timeline-bar.status-on-hold {
            background: var(--pastel-red);
        }

        .timeline-bar.status-in-progress {
            background: var(--pastel-blue);
        }

        .timeline-bar.status-stable {
            background: var(--pastel-purple);
        }

        .timeline-bar.status-idea {
            background: var(--pastel-orange);
        }

        .resize-handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 8px;
            cursor: ew-resize;
            z-index: 5;
        }

        .resize-handle-left {
            left: 0;
            border-left: 3px solid rgba(255, 255, 255, 0.3);
        }

        .resize-handle-right {
            right: 0;
            border-right: 3px solid rgba(255, 255, 255, 0.3);
        }

        .resize-handle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            font-size: 1.25rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .project-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .project-list-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .project-list-item:hover {
            border-color: var(--pastel-blue);
            background: var(--bg-hover);
        }

        .project-list-item input[type="checkbox"] {
            margin: 0;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            min-width: 300px;
            z-index: 2000;
            animation: slideIn 0.3s ease;
            box-shadow: var(--shadow);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-color: var(--pastel-green);
        }

        .notification.error {
            border-color: var(--pastel-red);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="logo">PKD Timeline</h1>
        <div class="header-actions">
            <a href="index.html" class="btn btn-secondary">← Back to Projects</a>
            <button class="btn" onclick="openAddProjectsModal()">Add Projects</button>
            <button class="btn" onclick="exportTimeline()">Export Timeline</button>
        </div>
    </div>

    <div class="timeline-controls">
        <div class="control-group">
            <span class="control-label">View Range:</span>
            <input type="month" id="startMonthInput" onchange="updateTimelineView()">
            <span style="color: var(--text-secondary);">to</span>
            <input type="month" id="endMonthInput" onchange="updateTimelineView()">
        </div>
        
        <div class="control-group">
            <span class="control-label">Quick Range:</span>
            <select id="quickRangeSelect" onchange="applyQuickRange()">
                <option value="">Select...</option>
                <option value="this-quarter">This Quarter</option>
                <option value="next-quarter">Next Quarter</option>
                <option value="this-year">This Year</option>
                <option value="next-year">Next Year</option>
            </select>
        </div>

        <button class="btn btn-secondary" onclick="clearTimeline()">Clear All</button>
    </div>

    <div class="timeline-container" id="timelineContainer"></div>

    <div class="modal" id="addProjectsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Projects to Timeline</h2>
                <button class="close-btn" onclick="closeAddProjectsModal()">×</button>
            </div>
            <div class="project-list" id="projectList"></div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="btn btn-secondary" onclick="closeAddProjectsModal()">Cancel</button>
                <button class="btn" onclick="addSelectedProjects()">Add Selected</button>
            </div>
        </div>
    </div>

    <script>
        const TIMELINE = {
            projects: [],
            allProjects: [],
            viewStartDate: '',
            viewEndDate: '',
            dragState: null,
            monthWidth: 120,
            weekWidth: 30
        };

        // Initialize
        function init() {
            loadDataFromLocalStorage();
            initializeDateRange();
            loadTimelineFromLocalStorage();
            renderTimeline();
        }

        function loadDataFromLocalStorage() {
            const stored = localStorage.getItem('pkdDashboardData');
            if (stored) {
                const data = JSON.parse(stored);
                TIMELINE.allProjects = data.projects || [];
            }
        }

        function loadTimelineFromLocalStorage() {
            const stored = localStorage.getItem('pkdTimelineData');
            if (stored) {
                const data = JSON.parse(stored);
                TIMELINE.projects = data.projects || [];
                if (data.viewStartDate) TIMELINE.viewStartDate = data.viewStartDate;
                if (data.viewEndDate) TIMELINE.viewEndDate = data.viewEndDate;
                
                // Update date inputs
                document.getElementById('startMonthInput').value = TIMELINE.viewStartDate;
                document.getElementById('endMonthInput').value = TIMELINE.viewEndDate;
            }
        }

        function saveTimelineToLocalStorage() {
            const data = {
                projects: TIMELINE.projects,
                viewStartDate: TIMELINE.viewStartDate,
                viewEndDate: TIMELINE.viewEndDate
            };
            localStorage.setItem('pkdTimelineData', JSON.stringify(data));
        }

        function initializeDateRange() {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = (today.getMonth() + 1).toString().padStart(2, '0');
            
            if (!TIMELINE.viewStartDate) {
                TIMELINE.viewStartDate = `${currentYear}-${currentMonth}`;
            }
            if (!TIMELINE.viewEndDate) {
                const endDate = new Date(today);
                endDate.setMonth(endDate.getMonth() + 11);
                TIMELINE.viewEndDate = `${endDate.getFullYear()}-${(endDate.getMonth() + 1).toString().padStart(2, '0')}`;
            }
            
            document.getElementById('startMonthInput').value = TIMELINE.viewStartDate;
            document.getElementById('endMonthInput').value = TIMELINE.viewEndDate;
        }

        function getMonthsBetween(start, end) {
            const months = [];
            const startDate = new Date(start + '-01');
            const endDate = new Date(end + '-01');
            
            let current = new Date(startDate);
            while (current <= endDate) {
                const year = current.getFullYear();
                const month = (current.getMonth() + 1).toString().padStart(2, '0');
                months.push(`${year}-${month}`);
                current.setMonth(current.getMonth() + 1);
            }
            
            return months;
        }

        function getMonthName(dateString) {
            const date = new Date(dateString + '-01');
            return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        }

        function isQuarterStart(dateString) {
            const month = parseInt(dateString.split('-')[1]);
            return month === 1 || month === 4 || month === 7 || month === 10;
        }

        function renderTimeline() {
            const container = document.getElementById('timelineContainer');
            
            if (TIMELINE.projects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Projects in Timeline</h3>
                        <p>Click "Add Projects" to get started</p>
                    </div>
                `;
                return;
            }

            const months = getMonthsBetween(TIMELINE.viewStartDate, TIMELINE.viewEndDate);
            const monthCount = months.length;

            // Sort projects by displayOrder
            TIMELINE.projects.sort((a, b) => (a.timeline?.displayOrder || 0) - (b.timeline?.displayOrder || 0));

            let html = `
                <div class="timeline-grid" style="--month-count: ${monthCount}">
                    <div class="timeline-header">
                        <div class="header-cell project-label">Project</div>
                        ${months.map(month => `
                            <div class="header-cell month-header ${isQuarterStart(month) ? 'quarter-start' : ''}">
                                ${getMonthName(month)}
                            </div>
                        `).join('')}
                    </div>
                    <div class="timeline-body">
                        ${TIMELINE.projects.map((project, index) => renderProjectRow(project, months, index)).join('')}
                    </div>
                </div>
            `;

            container.innerHTML = html;
            attachEventListeners();
        }

        function renderProjectRow(project, months, rowIndex) {
            const usersHTML = project.users && project.users.length > 0
                ? `<div class="project-users">
                    ${project.users.map(u => `<span class="user-badge">${u}</span>`).join('')}
                   </div>`
                : '';

            let barHTML = '';
            if (project.timeline?.startMonth && project.timeline?.endMonth) {
                const barPosition = calculateBarPosition(project, months);
                if (barPosition) {
                    barHTML = `
                        <div class="timeline-bar status-${project.status}" 
                             data-project-id="${project.id}"
                             style="left: ${barPosition.left}px; width: ${barPosition.width}px;">
                            <div class="resize-handle resize-handle-left" data-handle="left"></div>
                            ${project.title}
                            <div class="resize-handle resize-handle-right" data-handle="right"></div>
                        </div>
                    `;
                }
            }

            return `
                <div class="timeline-row">
                    <div class="project-info-cell" data-project-id="${project.id}" data-row-index="${rowIndex}">
                        <div class="project-name">${project.title}</div>
                        ${usersHTML}
                    </div>
                    ${months.map(month => `
                        <div class="timeline-cell ${isQuarterStart(month) ? 'quarter-start' : ''}" 
                             data-month="${month}" 
                             data-project-id="${project.id}">
                            ${barHTML}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function calculateBarPosition(project, months) {
            if (!project.timeline?.startMonth || !project.timeline?.endMonth) return null;

            const startIndex = months.indexOf(project.timeline.startMonth);
            const endIndex = months.indexOf(project.timeline.endMonth);

            if (startIndex === -1 || endIndex === -1) return null;

            const startWeek = project.timeline.startWeek || 0;
            const endWeek = project.timeline.endWeek || 3;

            const left = (startIndex * TIMELINE.monthWidth) + (startWeek * TIMELINE.weekWidth);
            const width = ((endIndex - startIndex) * TIMELINE.monthWidth) + 
                         ((endWeek - startWeek) * TIMELINE.weekWidth);

            return { left, width };
        }

        function attachEventListeners() {
            // Bar dragging
            document.querySelectorAll('.timeline-bar').forEach(bar => {
                bar.addEventListener('mousedown', handleBarMouseDown);
            });

            // Resize handles
            document.querySelectorAll('.resize-handle').forEach(handle => {
                handle.addEventListener('mousedown', handleResizeMouseDown);
            });

            // Row reordering
            document.querySelectorAll('.project-info-cell').forEach(cell => {
                cell.addEventListener('mousedown', handleRowMouseDown);
            });
        }

        function handleBarMouseDown(e) {
            if (e.target.classList.contains('resize-handle')) return;
            e.preventDefault();
            
            const bar = e.currentTarget;
            const projectId = parseInt(bar.dataset.projectId);
            const project = TIMELINE.projects.find(p => p.id === projectId);
            
            TIMELINE.dragState = {
                type: 'move',
                projectId: projectId,
                startX: e.clientX,
                originalStartMonth: project.timeline.startMonth,
                originalEndMonth: project.timeline.endMonth,
                originalStartWeek: project.timeline.startWeek || 0,
                originalEndWeek: project.timeline.endWeek || 3
            };

            bar.classList.add('dragging');
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }

        function handleResizeMouseDown(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const handle = e.currentTarget;
            const bar = handle.closest('.timeline-bar');
            const projectId = parseInt(bar.dataset.projectId);
            const project = TIMELINE.projects.find(p => p.id === projectId);
            
            TIMELINE.dragState = {
                type: 'resize',
                handle: handle.dataset.handle,
                projectId: projectId,
                startX: e.clientX,
                originalStartMonth: project.timeline.startMonth,
                originalEndMonth: project.timeline.endMonth,
                originalStartWeek: project.timeline.startWeek || 0,
                originalEndWeek: project.timeline.endWeek || 3
            };

            bar.classList.add('dragging');
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }

        function handleMouseMove(e) {
            if (!TIMELINE.dragState) return;

            const deltaX = e.clientX - TIMELINE.dragState.startX;
            const quarterMonths = Math.round(deltaX / TIMELINE.weekWidth);

            // Show visual feedback (could add ghost bar here)
        }

        function handleMouseUp(e) {
            if (!TIMELINE.dragState) return;

            const deltaX = e.clientX - TIMELINE.dragState.startX;
            const quarterMonths = Math.round(deltaX / TIMELINE.weekWidth);

            const project = TIMELINE.projects.find(p => p.id === TIMELINE.dragState.projectId);
            
            if (TIMELINE.dragState.type === 'move') {
                // Move both start and end
                const newStart = addQuarterMonths(
                    TIMELINE.dragState.originalStartMonth, 
                    TIMELINE.dragState.originalStartWeek, 
                    quarterMonths
                );
                const newEnd = addQuarterMonths(
                    TIMELINE.dragState.originalEndMonth, 
                    TIMELINE.dragState.originalEndWeek, 
                    quarterMonths
                );

                project.timeline.startMonth = newStart.month;
                project.timeline.startWeek = newStart.week;
                project.timeline.endMonth = newEnd.month;
                project.timeline.endWeek = newEnd.week;
            } else if (TIMELINE.dragState.type === 'resize') {
                if (TIMELINE.dragState.handle === 'left') {
                    const newStart = addQuarterMonths(
                        TIMELINE.dragState.originalStartMonth, 
                        TIMELINE.dragState.originalStartWeek, 
                        quarterMonths
                    );
                    project.timeline.startMonth = newStart.month;
                    project.timeline.startWeek = newStart.week;
                } else {
                    const newEnd = addQuarterMonths(
                        TIMELINE.dragState.originalEndMonth, 
                        TIMELINE.dragState.originalEndWeek, 
                        quarterMonths
                    );
                    project.timeline.endMonth = newEnd.month;
                    project.timeline.endWeek = newEnd.week;
                }
            }

            // Update localStorage for main dashboard
            updateMainDashboardData(project);
            saveTimelineToLocalStorage();

            document.querySelectorAll('.timeline-bar').forEach(bar => {
                bar.classList.remove('dragging');
            });

            TIMELINE.dragState = null;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);

            renderTimeline();
            showNotification('Project timeline updated', 'success');
        }

        function addQuarterMonths(monthString, weekOffset, quarterMonthsToAdd) {
            const date = new Date(monthString + '-01');
            const totalWeeks = (date.getMonth() * 4) + weekOffset + quarterMonthsToAdd;
            
            const newMonth = Math.floor(totalWeeks / 4);
            const newWeek = totalWeeks % 4;
            
            const year = date.getFullYear() + Math.floor(newMonth / 12);
            const month = (newMonth % 12) + 1;
            
            return {
                month: `${year}-${month.toString().padStart(2, '0')}`,
                week: newWeek < 0 ? 0 : newWeek > 3 ? 3 : newWeek
            };
        }

        function handleRowMouseDown(e) {
            // Row reordering - future feature
        }

        function updateTimelineView() {
            TIMELINE.viewStartDate = document.getElementById('startMonthInput').value;
            TIMELINE.viewEndDate = document.getElementById('endMonthInput').value;
            saveTimelineToLocalStorage();
            renderTimeline();
        }

        function applyQuickRange() {
            const select = document.getElementById('quickRangeSelect');
            const range = select.value;
            const today = new Date();
            
            let start, end;
            
            switch(range) {
                case 'this-quarter':
                    const quarter = Math.floor(today.getMonth() / 3);
                    start = new Date(today.getFullYear(), quarter * 3, 1);
                    end = new Date(today.getFullYear(), quarter * 3 + 2, 1);
                    break;
                case 'next-quarter':
                    const nextQuarter = Math.floor(today.getMonth() / 3) + 1;
                    start = new Date(today.getFullYear(), nextQuarter * 3, 1);
                    end = new Date(today.getFullYear(), nextQuarter * 3 + 2, 1);
                    break;
                case 'this-year':
                    start = new Date(today.getFullYear(), 0, 1);
                    end = new Date(today.getFullYear(), 11, 1);
                    break;
                case 'next-year':
                    start = new Date(today.getFullYear() + 1, 0, 1);
                    end = new Date(today.getFullYear() + 1, 11, 1);
                    break;
                default:
                    return;
            }
            
            TIMELINE.viewStartDate = `${start.getFullYear()}-${(start.getMonth() + 1).toString().padStart(2, '0')}`;
            TIMELINE.viewEndDate = `${end.getFullYear()}-${(end.getMonth() + 1).toString().padStart(2, '0')}`;
            
            document.getElementById('startMonthInput').value = TIMELINE.viewStartDate;
            document.getElementById('endMonthInput').value = TIMELINE.viewEndDate;
            
            select.value = '';
            saveTimelineToLocalStorage();
            renderTimeline();
        }

        function openAddProjectsModal() {
            loadDataFromLocalStorage();
            const modal = document.getElementById('addProjectsModal');
            const list = document.getElementById('projectList');
            
            const availableProjects = TIMELINE.allProjects.filter(p => 
                p.status !== 'complete' && !TIMELINE.projects.find(tp => tp.id === p.id)
            );

            if (availableProjects.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-secondary);">No available projects</div>';
            } else {
                list.innerHTML = availableProjects.map(p => `
                    <label class="project-list-item">
                        <input type="checkbox" value="${p.id}">
                        <div>
                            <div style="font-weight: 600;">${p.title}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                ${p.categories ? p.categories.join(', ') : ''}
                            </div>
                        </div>
                    </label>
                `).join('');
            }
            
            modal.classList.add('open');
        }

        function closeAddProjectsModal() {
            document.getElementById('addProjectsModal').classList.remove('open');
        }

        function addSelectedProjects() {
            const checkboxes = document.querySelectorAll('#projectList input[type="checkbox"]:checked');
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            const today = new Date();
            const currentMonth = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
            const endDate = new Date(today);
            endDate.setMonth(endDate.getMonth() + 2);
            const endMonth = `${endDate.getFullYear()}-${(endDate.getMonth() + 1).toString().padStart(2, '0')}`;
            
            selectedIds.forEach(id => {
                const project = TIMELINE.allProjects.find(p => p.id === id);
                if (project) {
                    if (!project.timeline) {
                        project.timeline = {
                            startMonth: currentMonth,
                            endMonth: endMonth,
                            startWeek: 0,
                            endWeek: 3,
                            displayOrder: TIMELINE.projects.length
                        };
                    }
                    TIMELINE.projects.push(project);
                    updateMainDashboardData(project);
                }
            });
            
            saveTimelineToLocalStorage();
            renderTimeline();
            closeAddProjectsModal();
            showNotification(`Added ${selectedIds.length} project(s)`, 'success');
        }

        function clearTimeline() {
            if (confirm('Remove all projects from timeline? Timeline data will be preserved.')) {
                TIMELINE.projects = [];
                saveTimelineToLocalStorage();
                renderTimeline();
                showNotification('Timeline cleared', 'success');
            }
        }

        function updateMainDashboardData(project) {
            const stored = localStorage.getItem('pkdDashboardData');
            if (stored) {
                const data = JSON.parse(stored);
                const projectIndex = data.projects.findIndex(p => p.id === project.id);
                if (projectIndex !== -1) {
                    data.projects[projectIndex] = project;
                    localStorage.setItem('pkdDashboardData', JSON.stringify(data));
                }
            }
        }

        function exportTimeline() {
            const data = {
                projects: TIMELINE.projects,
                viewStartDate: TIMELINE.viewStartDate,
                viewEndDate: TIMELINE.viewEndDate,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `timeline_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Timeline exported', 'success');
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
