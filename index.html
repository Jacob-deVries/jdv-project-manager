<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PKD Project Management Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1b;
            --bg-card: #232326;
            --bg-hover: #2a2a2d;
            --text-primary: #e8e8e9;
            --text-secondary: #9ca3af;
            --accent-blue: #7dd3fc;
            --accent-green: #86efac;
            --accent-orange: #fcd34d;
            --accent-red: #fca5a5;
            --accent-purple: #c4b5fd;
            --border-color: #333336;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            --pastel-green: #86efac;
            --pastel-green-dark: #4ade80;
            --pastel-red: #fca5a5;
            --pastel-red-dark: #f87171;
            --pastel-blue: #93c5fd;
            --pastel-blue-dark: #60a5fa;
            --pastel-purple: #c4b5fd;
            --pastel-purple-dark: #a78bfa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.02;
            z-index: 0;
            pointer-events: none;
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.01) 35px, rgba(255,255,255,.01) 70px),
                repeating-linear-gradient(-45deg, transparent, transparent 35px, rgba(255,255,255,.01) 35px, rgba(255,255,255,.01) 70px);
        }

        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 6px;
            transition: background 0.3s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--pastel-purple);
        }

        *:focus-visible {
            outline: 2px solid var(--pastel-blue);
            outline-offset: 2px;
            border-radius: 4px;
        }

        #passwordScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .password-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 3rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .password-logo {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 2rem;
        }

        .password-title {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .password-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .password-input {
            width: 100%;
            padding: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            text-align: center;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
        }

        .password-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .password-input.error {
            border-color: var(--accent-red);
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .password-error {
            color: var(--accent-red);
            font-size: 0.875rem;
            margin-bottom: 1rem;
            opacity: 0;
            height: 20px;
        }

        .password-error.show {
            opacity: 1;
        }

        .password-submit {
            width: 100%;
            padding: 1rem;
            background: var(--pastel-blue);
            border: none;
            border-radius: 8px;
            color: var(--bg-primary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .password-submit:hover {
            background: var(--pastel-blue-dark);
        }

        #dashboardWrapper {
            display: none;
            padding: 2rem;
        }

        .header {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(35, 35, 38, 0.95) 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow);
            position: relative;
            z-index: 10;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 20%;
            right: 20%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--pastel-purple), transparent);
            opacity: 0.5;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .nav-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s, border-color 0.2s;
        }

        .nav-btn:hover {
            background: var(--bg-hover);
            border-color: var(--pastel-blue);
        }

        .nav-btn.active {
            background: var(--pastel-purple);
            border-color: var(--pastel-purple);
            color: var(--bg-primary);
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn-primary {
            padding: 0.5rem 1rem;
            background: var(--pastel-blue);
            border: none;
            border-radius: 8px;
            color: var(--bg-primary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: var(--pastel-blue-dark);
        }

        .page-container {
            display: none;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-container.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(35, 35, 38, 0.85) 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--pastel-blue), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--pastel-blue);
            box-shadow: 0 0 0 2px rgba(147, 197, 253, 0.1);
        }

        .dropdown-filter {
            position: relative;
        }

        .dropdown-button {
            padding: 0.75rem 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .dropdown-button:hover {
            border-color: var(--pastel-purple);
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            min-width: 200px;
            background: rgba(35, 35, 38, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
            box-shadow: var(--shadow);
            z-index: 50;
            max-height: 300px;
            overflow-y: auto;
            animation: dropdownSlide 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dropdown-select-controls {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 0.5rem;
        }

        .dropdown-select-btn {
            flex: 1;
            padding: 0.25rem 0.5rem;
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dropdown-select-btn:hover {
            background: var(--pastel-blue);
            color: var(--bg-primary);
            border-color: var(--pastel-blue);
        }

        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-menu.open {
            display: block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .dropdown-item:hover {
            background: var(--bg-hover);
            transform: translateX(4px);
        }

        .dropdown-item input[type="checkbox"] {
            margin-right: 0.75rem;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toggle-switch {
            width: 48px;
            height: 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            position: relative;
        }

        .toggle-switch.active {
            background: var(--pastel-purple);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        .project-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(35, 35, 38, 0.95) 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .project-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--pastel-blue), var(--pastel-purple), var(--pastel-blue));
            border-radius: 12px;
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s;
        }

        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.5);
        }

        .project-card:hover::before {
            opacity: 0.1;
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .project-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
        }

        .project-title:hover {
            color: var(--accent-blue);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .project-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        .project-actions {
            display: flex;
            gap: 0.5rem;
        }

        .edit-btn, .complete-btn, .delete-btn {
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            border: none;
            transition: opacity 0.2s;
        }
        
        .edit-btn:hover, .complete-btn:hover, .delete-btn:hover {
            opacity: 0.8;
        }

        .timeline-wrapper {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 180px);
            min-height: 500px;
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(35, 35, 38, 0.95) 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .timeline-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .timeline-header {
            display: grid;
            grid-template-rows: auto auto;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            flex-shrink: 0;
        }

        .timeline-year-row {
            display: grid;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .timeline-year-cell {
            padding: 0.5rem 0;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .timeline-month-row {
            display: grid;
        }

        .timeline-month-cell {
            padding: 0.5rem 0;
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-secondary);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .timeline-body {
            flex: 1;
            overflow-y: auto;
        }

        .timeline-project-row {
            display: grid;
            grid-template-columns: 250px 1fr auto;
            align-items: center;
            padding: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }

        .timeline-project-row:hover {
            border-color: var(--pastel-blue);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .timeline-project-info {
            min-width: 250px;
            max-width: 250px;
            cursor: pointer;
        }

        .timeline-header {
            padding: 0 1rem;
        }

        .timeline-project-info:hover .timeline-project-title {
            color: var(--pastel-blue);
        }

        .timeline-project-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .timeline-project-users {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .timeline-gantt-container {
            position: relative;
            height: 40px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 4px;
            box-sizing: border-box;
        }

        .timeline-gantt-bar {
            height: 32px;
            margin-top: 4px;
            background: linear-gradient(135deg, var(--pastel-blue), var(--pastel-purple));
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--bg-primary);
            font-size: 0.75rem;
            font-weight: 500;
            user-select: none;
            transition: box-shadow 0.2s;
            border: 2px solid transparent;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            padding: 0;
            box-sizing: border-box;
            position: absolute;
            top: 0;
        }

        .timeline-gantt-bar:hover {
            box-shadow: 0 4px 12px rgba(147, 197, 253, 0.5);
            border-color: var(--pastel-blue-dark);
        }

        .timeline-gantt-bar.dragging {
            opacity: 0.8;
            cursor: grabbing;
            z-index: 10;
        }

        .timeline-gantt-bar-body {
            flex: 1;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 0 8px;
        }

        .timeline-gantt-handle {
            position: absolute;
            width: 16px;
            height: 100%;
            cursor: ew-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        .timeline-gantt-handle-left {
            left: 0;
            border-left: 3px solid rgba(255, 255, 255, 0.7);
            border-radius: 6px 0 0 6px;
        }

        .timeline-gantt-handle-right {
            right: 0;
            border-right: 3px solid rgba(255, 255, 255, 0.7);
            border-radius: 0 6px 6px 0;
        }

        .timeline-gantt-handle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .timeline-totals-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }

        .timeline-totals-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .timeline-totals-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .timeline-totals-table th {
            background: var(--bg-secondary);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .timeline-totals-table td {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .timeline-totals-table tr:hover {
            background: var(--bg-hover);
        }

        .timeline-totals-over {
            color: var(--pastel-red);
            font-weight: 600;
        }

        .timeline-totals-full {
            color: var(--pastel-green);
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(35, 35, 38, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn-save {
            padding: 0.75rem 1.5rem;
            background: var(--pastel-green);
            border: none;
            border-radius: 8px;
            color: var(--bg-primary);
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-save:hover {
            background: var(--pastel-green-dark);
        }

        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
        }

        .notification {
            background: rgba(35, 35, 38, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            min-width: 300px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-color: var(--pastel-green);
        }

        .notification.error {
            border-color: var(--pastel-red);
        }

        .notification.info {
            border-color: var(--pastel-blue);
        }

        .settings-list-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            cursor: move;
        }

        .settings-list-item.drag-over {
            border-color: var(--pastel-blue);
            background: var(--bg-hover);
        }

        .drag-handle {
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: grab;
        }

        .note-header-controls {
            display: flex;
            gap: 0.5rem;
        }

        .btn-delete-note {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--pastel-red);
            color: var(--pastel-red);
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-delete-note:hover {
            background: var(--pastel-red);
            color: var(--bg-primary);
        }

        @media (max-width: 768px) {
            #projectsPage .container {
                grid-template-columns: 1fr !important;
            }
            
            #projectsGrid {
                grid-template-columns: 1fr !important;
            }

            .timeline-view {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="notification-container" id="notificationContainer"></div>

    <div id="passwordScreen">
        <div class="password-container">
            <div class="password-logo">PKD Dashboard</div>
            <h2 class="password-title">Secure Access</h2>
            <p class="password-subtitle">Please enter your password to continue</p>
            <input type="password" class="password-input" id="passwordInput" placeholder="Enter password">
            <div class="password-error" id="passwordError">Incorrect password. Please try again.</div>
            <button class="password-submit" onclick="checkPassword()">Access Dashboard</button>
        </div>
    </div>

    <div id="dashboardWrapper">
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1 class="logo">PKD Dashboard</h1>
                    <div class="nav-buttons">
                        <button class="nav-btn active" onclick="showPage('projects')">Projects & Notes</button>
                        <button class="nav-btn" onclick="showPage('timeline')">Timeline View</button>
                    </div>
                </div>
                <div class="header-actions">
                    <span id="lastUpdatedText">Last Updated: Never</span>
                    <button class="btn-primary" id="projectsOnlyBtn" onclick="openCreateModal()">New Project</button>
                    <button class="btn-primary" id="manageBtn" onclick="openManageModal()">Manage Settings</button>
                    <div id="timelineHeaderActions" style="display: none;">
                        <button class="btn-primary" onclick="showAddTimelineProjectMenu()">+ Add to Timeline</button>
                    </div>
                    <button class="btn-primary" onclick="exportPKD()">Export PKD</button>
                    <button class="btn-primary" onclick="document.getElementById('fileInput').click()">Upload PKD</button>
                    <input type="file" id="fileInput" style="display: none;" accept=".txt" onchange="handleFileUpload(event)">
                </div>
            </div>
        </header>

        <div id="projectsPage" class="page-container active">
            <div class="container" style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; max-width: none; height: calc(100vh - 200px);">
                <div style="display: flex; flex-direction: column; overflow: hidden;">
                    <div id="statsSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div style="font-size: 2rem; color: var(--accent-blue); font-weight: 600;" id="activeCount">0</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">Active Projects</div>
                        </div>
                        <div class="stat-card">
                            <div style="font-size: 2rem; color: var(--accent-green); font-weight: 600;" id="completeCount">0</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">Completed</div>
                        </div>
                    </div>

                    <div class="controls">
                        <div class="search-box">
                            <input type="text" class="search-input" placeholder="Search projects..." id="searchInput" oninput="renderProjects()">
                        </div>
                        
                        <div class="dropdown-filter">
                            <button class="dropdown-button" onclick="toggleDropdown('categoryMenu')">
                                Categories <span id="categoryCount"></span>
                            </button>
                            <div class="dropdown-menu" id="categoryMenu"></div>
                        </div>

                        <div class="dropdown-filter">
                            <button class="dropdown-button" onclick="toggleDropdown('statusMenu')">
                                Statuses <span id="statusCount"></span>
                            </button>
                            <div class="dropdown-menu" id="statusMenu"></div>
                        </div>

                        <div class="dropdown-filter">
                            <button class="dropdown-button" onclick="toggleDropdown('userMenu')">
                                Users <span id="userCount"></span>
                            </button>
                            <div class="dropdown-menu" id="userMenu"></div>
                        </div>

                        <div class="toggle-container">
                            <label>Show Completed</label>
                            <div class="toggle-switch" id="showCompletedToggle" onclick="toggleCompleted()">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                    </div>

                    <div style="flex: 1; overflow-y: auto; padding-right: 0.5rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;" id="projectsGrid"></div>
                    </div>
                </div>
                
                <div style="display: flex; flex-direction: column; overflow: hidden;">
                    <div style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; display: flex; flex-direction: column; height: 100%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-shrink: 0;">
                            <select id="notesSelector" onchange="switchNote()" style="flex: 1; padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.875rem; margin-right: 0.5rem;">
                                <option value="Nymbl">Nymbl</option>
                                <option value="Cindy">Cindy</option>
                                <option value="Me">Me</option>
                            </select>
                            <div class="note-header-controls">
                                <button class="btn-primary" onclick="addNewNote()" style="padding: 0.5rem 1rem; font-size: 0.875rem; flex-shrink: 0;">+ New Note</button>
                                <button class="btn-delete-note" onclick="deleteCurrentNote()">Delete</button>
                            </div>
                        </div>
                        <textarea id="notesTextarea" style="flex: 1; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; color: var(--text-primary); font-size: 0.875rem; resize: none; font-family: inherit; overflow-y: auto;" placeholder="Enter notes...
• Use bullet points with • or -
• Hyphens auto-convert to bullets
• All formatting carries over to PKD export" oninput="handleNotesInput(event)"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div id="timelinePage" class="page-container">
            <div class="container" style="max-width: none;">
                <div class="timeline-wrapper">
                    <!-- Timeline will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const APP = {
            projects: [],
            categories: [],
            statuses: [],
            users: [],
            selectedCategories: [],
            selectedStatuses: [],
            selectedUsers: [],
            showCompleted: false,
            lastUpdated: 'Never',
            currentEditingProject: null,
            currentProjectLinks: [],
            notes: {
                nymbl: '',
                cindy: '',
                me: ''
            },
            currentNoteName: 'Nymbl',
            currentPage: 'projects',
            PASSWORD_HASH: 2147093827,
            timelineFilters: {
                categories: [],
                statuses: [],
                users: []
            },
            timelineStartDate: new Date(),
            timelineMonthsToShow: 12,
            timelineProjects: [],
            isDraggingGantt: false,
            ganttDragData: null
        };

        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash;
        }

        function checkPassword() {
            const input = document.getElementById('passwordInput');
            const error = document.getElementById('passwordError');
            const password = input.value;
            
            if (hashCode(password) === APP.PASSWORD_HASH) {
                document.getElementById('passwordScreen').style.display = 'none';
                document.getElementById('dashboardWrapper').style.display = 'block';
                initializeDashboard();
            } else {
                input.classList.add('error');
                error.classList.add('show');
                setTimeout(() => {
                    input.classList.remove('error');
                    error.classList.remove('show');
                }, 2000);
            }
        }

        function initializeDashboard() {
            updateStats();
            updateFilterDropdowns();
            loadNotes();
            
            const grid = document.getElementById('projectsGrid');
            grid.innerHTML = '<div style="text-align: center; padding: 3rem; color: var(--text-secondary); grid-column: 1 / -1;"><h3>Welcome to PKD Dashboard</h3><p style="margin-top: 1rem;">Upload a PKD file to get started, or create your first project.</p></div>';
            
            document.getElementById('lastUpdatedText').textContent = `Last Updated: ${APP.lastUpdated}`;
        }

        function showPage(page) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.page-container').forEach(container => container.classList.remove('active'));
            document.getElementById(`${page}Page`).classList.add('active');
            
            const projectsOnlyBtn = document.getElementById('projectsOnlyBtn');
            const manageBtn = document.getElementById('manageBtn');
            const timelineHeaderActions = document.getElementById('timelineHeaderActions');
            
            if (page === 'projects') {
                projectsOnlyBtn.style.display = 'inline-block';
                manageBtn.style.display = 'inline-block';
                if (timelineHeaderActions) timelineHeaderActions.style.display = 'none';
            } else {
                projectsOnlyBtn.style.display = 'none';
                manageBtn.style.display = 'none';
                if (timelineHeaderActions) timelineHeaderActions.style.display = 'flex';
            }
            
            APP.currentPage = page;
            
            if (page === 'timeline') {
                renderTimeline();
            }
        }

        function saveToLocalStorage() {
            if (typeof localStorage !== 'undefined') {
                const data = {
                    projects: APP.projects,
                    categories: APP.categories,
                    statuses: APP.statuses,
                    users: APP.users,
                    lastUpdated: APP.lastUpdated,
                    notes: APP.notes,
                    timelineProjects: APP.timelineProjects,
                    timelineMonthsToShow: APP.timelineMonthsToShow
                };
                try {
                    localStorage.setItem('pkdDashboardData', JSON.stringify(data));
                } catch (e) {
                    console.error('Error saving to localStorage:', e);
                }
            }
        }

        function updateStats() {
            const active = APP.projects.filter(p => p.status !== 'complete').length;
            const complete = APP.projects.filter(p => p.status === 'complete').length;
            
            document.getElementById('activeCount').textContent = active;
            document.getElementById('completeCount').textContent = complete;
        }

        function updateFilterDropdowns() {
            if (APP.selectedCategories.length === 0 && APP.categories.length > 0) {
                APP.selectedCategories = [...APP.categories];
            }
            if (APP.selectedStatuses.length === 0 && APP.statuses.length > 0) {
                APP.selectedStatuses = [...APP.statuses];
            }
            if (APP.selectedUsers.length === 0 && APP.users.length > 0) {
                APP.selectedUsers = [...APP.users];
            }
            
            const categoryMenu = document.getElementById('categoryMenu');
            categoryMenu.innerHTML = '';
            
            const categoryControls = document.createElement('div');
            categoryControls.className = 'dropdown-select-controls';
            categoryControls.innerHTML = `
                <button class="dropdown-select-btn" onclick="selectAllCategories()">Select All</button>
                <button class="dropdown-select-btn" onclick="deselectAllCategories()">Deselect All</button>
            `;
            categoryMenu.appendChild(categoryControls);
            
            APP.categories.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                const isChecked = APP.selectedCategories.includes(cat) ? 'checked' : '';
                item.innerHTML = `
                    <input type="checkbox" id="cat-${cat}" onchange="toggleCategory('${cat}')" ${isChecked}>
                    <label for="cat-${cat}">${cat}</label>
                `;
                categoryMenu.appendChild(item);
            });

            const statusMenu = document.getElementById('statusMenu');
            statusMenu.innerHTML = '';
            
            const statusControls = document.createElement('div');
            statusControls.className = 'dropdown-select-controls';
            statusControls.innerHTML = `
                <button class="dropdown-select-btn" onclick="selectAllStatuses()">Select All</button>
                <button class="dropdown-select-btn" onclick="deselectAllStatuses()">Deselect All</button>
            `;
            statusMenu.appendChild(statusControls);
            
            APP.statuses.forEach(status => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                const isChecked = APP.selectedStatuses.includes(status) ? 'checked' : '';
                item.innerHTML = `
                    <input type="checkbox" id="status-${status}" onchange="toggleStatus('${status}')" ${isChecked}>
                    <label for="status-${status}">${status}</label>
                `;
                statusMenu.appendChild(item);
            });

            const userMenu = document.getElementById('userMenu');
            userMenu.innerHTML = '';
            
            const userControls = document.createElement('div');
            userControls.className = 'dropdown-select-controls';
            userControls.innerHTML = `
                <button class="dropdown-select-btn" onclick="selectAllUsers()">Select All</button>
                <button class="dropdown-select-btn" onclick="deselectAllUsers()">Deselect All</button>
            `;
            userMenu.appendChild(userControls);
            
            APP.users.forEach(user => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                const isChecked = APP.selectedUsers.includes(user) ? 'checked' : '';
                item.innerHTML = `
                    <input type="checkbox" id="user-${user}" onchange="toggleUser('${user}')" ${isChecked}>
                    <label for="user-${user}">${user}</label>
                `;
                userMenu.appendChild(item);
            });
            
            updateTimelineFilterDropdowns();
            updateFilterCounts();
        }

        function updateTimelineFilterDropdowns() {
            if (APP.timelineFilters.categories.length === 0 && APP.categories.length > 0) {
                APP.timelineFilters.categories = [...APP.categories];
            }
            if (APP.timelineFilters.statuses.length === 0 && APP.statuses.length > 0) {
                APP.timelineFilters.statuses = [...APP.statuses];
            }
            if (APP.timelineFilters.users.length === 0 && APP.users.length > 0) {
                APP.timelineFilters.users = [...APP.users];
            }

            const timelineCategoryMenu = document.getElementById('timelineCategoryMenu');
            if (timelineCategoryMenu) {
                timelineCategoryMenu.innerHTML = '';
                
                const categoryControls = document.createElement('div');
                categoryControls.className = 'dropdown-select-controls';
                categoryControls.innerHTML = `
                    <button class="dropdown-select-btn" onclick="selectAllTimelineCategories()">Select All</button>
                    <button class="dropdown-select-btn" onclick="deselectAllTimelineCategories()">Deselect All</button>
                `;
                timelineCategoryMenu.appendChild(categoryControls);
                
                APP.categories.forEach(cat => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    const isChecked = APP.timelineFilters.categories.includes(cat) ? 'checked' : '';
                    item.innerHTML = `
                        <input type="checkbox" id="timeline-cat-${cat}" onchange="toggleTimelineCategory('${cat}')" ${isChecked}>
                        <label for="timeline-cat-${cat}">${cat}</label>
                    `;
                    timelineCategoryMenu.appendChild(item);
                });
            }

            const timelineStatusMenu = document.getElementById('timelineStatusMenu');
            if (timelineStatusMenu) {
                timelineStatusMenu.innerHTML = '';
                
                const statusControls = document.createElement('div');
                statusControls.className = 'dropdown-select-controls';
                statusControls.innerHTML = `
                    <button class="dropdown-select-btn" onclick="selectAllTimelineStatuses()">Select All</button>
                    <button class="dropdown-select-btn" onclick="deselectAllTimelineStatuses()">Deselect All</button>
                `;
                timelineStatusMenu.appendChild(statusControls);
                
                APP.statuses.forEach(status => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    const isChecked = APP.timelineFilters.statuses.includes(status) ? 'checked' : '';
                    item.innerHTML = `
                        <input type="checkbox" id="timeline-status-${status}" onchange="toggleTimelineStatus('${status}')" ${isChecked}>
                        <label for="timeline-status-${status}">${status}</label>
                    `;
                    timelineStatusMenu.appendChild(item);
                });
            }

            const timelineUserMenu = document.getElementById('timelineUserMenu');
            if (timelineUserMenu) {
                timelineUserMenu.innerHTML = '';
                
                const userControls = document.createElement('div');
                userControls.className = 'dropdown-select-controls';
                userControls.innerHTML = `
                    <button class="dropdown-select-btn" onclick="selectAllTimelineUsers()">Select All</button>
                    <button class="dropdown-select-btn" onclick="deselectAllTimelineUsers()">Deselect All</button>
                `;
                timelineUserMenu.appendChild(userControls);
                
                APP.users.forEach(user => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    const isChecked = APP.timelineFilters.users.includes(user) ? 'checked' : '';
                    item.innerHTML = `
                        <input type="checkbox" id="timeline-user-${user}" onchange="toggleTimelineUser('${user}')" ${isChecked}>
                        <label for="timeline-user-${user}">${user}</label>
                    `;
                    timelineUserMenu.appendChild(item);
                });
            }

            const timelineCategoryCount = document.getElementById('timelineCategoryCount');
            if (timelineCategoryCount) {
                timelineCategoryCount.textContent = APP.timelineFilters.categories.length > 0 ? `(${APP.timelineFilters.categories.length})` : '';
            }

            const timelineStatusCount = document.getElementById('timelineStatusCount');
            if (timelineStatusCount) {
                timelineStatusCount.textContent = APP.timelineFilters.statuses.length > 0 ? `(${APP.timelineFilters.statuses.length})` : '';
            }

            const timelineUserCount = document.getElementById('timelineUserCount');
            if (timelineUserCount) {
                timelineUserCount.textContent = APP.timelineFilters.users.length > 0 ? `(${APP.timelineFilters.users.length})` : '';
            }
        }

        function toggleTimelineCategory(category) {
            const index = APP.timelineFilters.categories.indexOf(category);
            if (index > -1) {
                APP.timelineFilters.categories.splice(index, 1);
            } else {
                APP.timelineFilters.categories.push(category);
            }
            updateTimelineFilterDropdowns();
            renderTimeline();
        }

        function toggleTimelineStatus(status) {
            const index = APP.timelineFilters.statuses.indexOf(status);
            if (index > -1) {
                APP.timelineFilters.statuses.splice(index, 1);
            } else {
                APP.timelineFilters.statuses.push(status);
            }
            updateTimelineFilterDropdowns();
            renderTimeline();
        }

        function toggleTimelineUser(user) {
            const index = APP.timelineFilters.users.indexOf(user);
            if (index > -1) {
                APP.timelineFilters.users.splice(index, 1);
            } else {
                APP.timelineFilters.users.push(user);
            }
            updateTimelineFilterDropdowns();
            renderTimeline();
        }

        function toggleDropdown(menuId) {
            const menu = document.getElementById(menuId);
            menu.classList.toggle('open');
        }

        function toggleCategory(category) {
            const index = APP.selectedCategories.indexOf(category);
            if (index > -1) {
                APP.selectedCategories.splice(index, 1);
            } else {
                APP.selectedCategories.push(category);
            }
            updateFilterCounts();
            renderProjects();
        }

        function toggleStatus(status) {
            const index = APP.selectedStatuses.indexOf(status);
            if (index > -1) {
                APP.selectedStatuses.splice(index, 1);
            } else {
                APP.selectedStatuses.push(status);
            }
            updateFilterCounts();
            renderProjects();
        }

        function toggleUser(user) {
            const index = APP.selectedUsers.indexOf(user);
            if (index > -1) {
                APP.selectedUsers.splice(index, 1);
            } else {
                APP.selectedUsers.push(user);
            }
            updateFilterCounts();
            renderProjects();
        }

        function selectAllCategories() {
            APP.selectedCategories = [...APP.categories];
            updateFilterDropdowns();
            renderProjects();
        }

        function deselectAllCategories() {
            APP.selectedCategories = [];
            updateFilterDropdowns();
            renderProjects();
        }

        function selectAllStatuses() {
            APP.selectedStatuses = [...APP.statuses];
            updateFilterDropdowns();
            renderProjects();
        }

        function deselectAllStatuses() {
            APP.selectedStatuses = [];
            updateFilterDropdowns();
            renderProjects();
        }

        function selectAllUsers() {
            APP.selectedUsers = [...APP.users];
            updateFilterDropdowns();
            renderProjects();
        }

        function deselectAllUsers() {
            APP.selectedUsers = [];
            updateFilterDropdowns();
            renderProjects();
        }

        function selectAllTimelineCategories() {
            APP.timelineFilters.categories = [...APP.categories];
            updateTimelineFilterDropdowns();
            renderTimeline();
        }

        function deselectAllTimelineCategories() {
            APP.timelineFilters.categories = [];
            updateTimelineFilterDropdowns();
            renderTimeline();
        }

        function selectAllTimelineStatuses() {
            APP.timelineFilters.statuses = [...APP.statuses];
            updateTimelineFilterDropdowns();
            renderTimeline();
        }

        function deselectAllTimelineStatuses() {
            APP.timelineFilters.statuses = [];
            updateTimelineFilterDropdowns();
            renderTimeline();
        }

        function selectAllTimelineUsers() {
            APP.timelineFilters.users = [...APP.users];
            updateTimelineFilterDropdowns();
            renderTimeline();
        }

        function deselectAllTimelineUsers() {
            APP.timelineFilters.users = [];
            updateTimelineFilterDropdowns();
            renderTimeline();
        }

        function updateFilterCounts() {
            document.getElementById('categoryCount').textContent = APP.selectedCategories.length > 0 ? `(${APP.selectedCategories.length})` : '';
            document.getElementById('statusCount').textContent = APP.selectedStatuses.length > 0 ? `(${APP.selectedStatuses.length})` : '';
            document.getElementById('userCount').textContent = APP.selectedUsers.length > 0 ? `(${APP.selectedUsers.length})` : '';
        }

        function toggleCompleted() {
            APP.showCompleted = !APP.showCompleted;
            document.getElementById('showCompletedToggle').classList.toggle('active');
            renderProjects();
        }

        function renderProjects() {
            const grid = document.getElementById('projectsGrid');
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = APP.projects.filter(project => {
                if (!APP.showCompleted && project.status === 'complete') return false;
                
                if (APP.selectedCategories.length > 0) {
                    const hasCategory = project.categories && 
                        project.categories.some(cat => APP.selectedCategories.includes(cat));
                    if (!hasCategory) return false;
                }
                
                if (APP.selectedStatuses.length > 0) {
                    if (!APP.selectedStatuses.includes(project.status)) return false;
                }

                if (APP.selectedUsers.length > 0) {
                    const hasUser = project.users && project.users.length > 0 &&
                        project.users.some(user => APP.selectedUsers.includes(user));
                    if (!hasUser) return false;
                }
                
                if (search) {
                    const searchInProject = 
                        project.title.toLowerCase().includes(search) ||
                        (project.keyDetails && project.keyDetails.toLowerCase().includes(search)) ||
                        (project.nextSteps && project.nextSteps.toLowerCase().includes(search));
                    if (!searchInProject) return false;
                }
                
                return true;
            });
            
            filtered.sort((a, b) => {
                const priorityA = a.priority || 999;
                const priorityB = b.priority || 999;
                return priorityA - priorityB;
            });
            
            grid.innerHTML = '';
            
            if (filtered.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 3rem; color: var(--text-secondary); grid-column: 1 / -1;">No projects found. Upload a PKD file to get started.</div>';
                return;
            }
            
            filtered.forEach(project => {
                const card = createProjectCard(project);
                grid.appendChild(card);
            });
        }

        function createProjectCard(project) {
            const card = document.createElement('div');
            card.className = 'project-card';
            
            let statusColor = '--pastel-blue';
            if (project.status === 'complete') statusColor = '--text-secondary';
            else if (project.status === 'on-hold') statusColor = '--pastel-red';
            else if (project.status === 'moving') statusColor = '--pastel-green';
            else if (project.status === 'stable') statusColor = '--pastel-purple';
            else if (project.status === 'in-progress') statusColor = '--pastel-blue';
            else if (project.status === 'idea') statusColor = '--accent-orange';
            
            card.innerHTML = `
                <div class="project-header">
                    <div>
                        <div class="project-title" onclick="openProjectModal(${project.id})">${project.title}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">ID: ${project.id} | Priority: ${project.priority || 999}</div>
                    </div>
                    <span class="status-badge" style="background: var(${statusColor}); color: ${statusColor.includes('text-secondary') ? 'var(--text-secondary)' : 'var(--bg-primary)'};">${project.status}</span>
                </div>
                ${project.users && project.users.length > 0 ? `<div style="margin-bottom: 0.5rem; color: var(--pastel-purple); font-size: 0.875rem;">Users: ${project.users.join(', ')}</div>` : ''}
                <div style="margin: 1rem 0; color: var(--text-secondary); font-size: 0.875rem;">
                    ${project.keyDetails ? project.keyDetails.substring(0, 100) + (project.keyDetails.length > 100 ? '...' : '') : 'No details'}
                </div>
                <div class="project-footer">
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        ${project.categories && project.categories.length > 0 ? project.categories.map(cat => 
                            `<span style="padding: 0.25rem 0.5rem; background: rgba(147, 197, 253, 0.15); border-radius: 6px; font-size: 0.75rem; color: var(--pastel-blue);">${cat}</span>`
                        ).join('') : ''}
                    </div>
                    <div class="project-actions">
                        <button class="edit-btn" style="background: var(--pastel-purple); color: var(--bg-primary); font-weight: 500;" onclick="openEditModal(${project.id})">Edit</button>
                        ${project.status !== 'complete' ? 
                            `<button class="complete-btn" style="background: var(--pastel-green); color: var(--bg-primary); font-weight: 500;" onclick="markComplete(${project.id})">Complete</button>` : ''}
                        <button class="delete-btn" style="background: var(--pastel-red); color: var(--bg-primary); font-weight: 500;" onclick="deleteProject(${project.id})">Delete</button>
                    </div>
                </div>
            `;
            
            return card;
        }

        function renderTimeline() {
            const timelineWrapper = document.querySelector('.timeline-wrapper');
            if (!timelineWrapper) return;

            const currentYear = APP.timelineStartDate.getFullYear();
            const currentMonth = APP.timelineStartDate.getMonth();
            
            const months = [];
            const years = [];
            
            for (let i = 0; i < APP.timelineMonthsToShow; i++) {
                const date = new Date(currentYear, currentMonth + i, 1);
                months.push({
                    name: date.toLocaleDateString('en-US', { month: 'short' }),
                    year: date.getFullYear()
                });
            }
            
            const yearSpans = [];
            let currentYearSpan = { year: months[0].year, count: 1 };
            
            for (let i = 1; i < months.length; i++) {
                if (months[i].year === currentYearSpan.year) {
                    currentYearSpan.count++;
                } else {
                    yearSpans.push(currentYearSpan);
                    currentYearSpan = { year: months[i].year, count: 1 };
                }
            }
            yearSpans.push(currentYearSpan);
            
            const timelineHTML = `
                <div class="timeline-controls">
                    <button class="btn-primary" onclick="shiftTimelineBack()">← Previous</button>
                    <button class="btn-primary" onclick="resetTimelineToToday()">Today</button>
                    <button class="btn-primary" onclick="shiftTimelineForward()">Next →</button>
                    
                    <div class="dropdown-filter">
                        <button class="dropdown-button" onclick="toggleDropdown('timelineCategoryMenu')">
                            Filter by Category <span id="timelineCategoryCount"></span>
                        </button>
                        <div class="dropdown-menu" id="timelineCategoryMenu"></div>
                    </div>
                    
                    <div class="dropdown-filter">
                        <button class="dropdown-button" onclick="toggleDropdown('timelineStatusMenu')">
                            Filter by Status <span id="timelineStatusCount"></span>
                        </button>
                        <div class="dropdown-menu" id="timelineStatusMenu"></div>
                    </div>
                    
                    <div class="dropdown-filter">
                        <button class="dropdown-button" onclick="toggleDropdown('timelineUserMenu')">
                            Filter by User <span id="timelineUserCount"></span>
                        </button>
                        <div class="dropdown-menu" id="timelineUserMenu"></div>
                    </div>
                    
                    <div style="flex: 1;"></div>
                    <select id="timelineMonthsSelect" onchange="changeTimelineMonths()" style="padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.875rem;">
                        <option value="6" ${APP.timelineMonthsToShow === 6 ? 'selected' : ''}>6 Months</option>
                        <option value="12" ${APP.timelineMonthsToShow === 12 ? 'selected' : ''}>12 Months</option>
                        <option value="18" ${APP.timelineMonthsToShow === 18 ? 'selected' : ''}>18 Months</option>
                        <option value="24" ${APP.timelineMonthsToShow === 24 ? 'selected' : ''}>24 Months</option>
                    </select>
                </div>
                <div class="timeline-header">
                    <div class="timeline-year-row" style="grid-template-columns: 250px ${yearSpans.map(y => `repeat(${y.count}, 1fr)`).join(' ')};">
                        <div class="timeline-year-cell" style="border-right: 2px solid var(--border-color);">Project</div>
                        ${yearSpans.map(y => `<div class="timeline-year-cell" style="grid-column: span ${y.count};">${y.year}</div>`).join('')}
                    </div>
                    <div class="timeline-month-row" style="grid-template-columns: 250px repeat(${months.length}, 1fr);">
                        <div class="timeline-month-cell" style="border-right: 2px solid var(--border-color);">Users & Allocation</div>
                        ${months.map(m => `<div class="timeline-month-cell">${m.name}</div>`).join('')}
                    </div>
                </div>
                <div class="timeline-body" id="timelineBody">
                    ${getFilteredTimelineProjects().map((tp, idx) => renderTimelineProjectRow(tp, idx)).join('')}
                    ${getFilteredTimelineProjects().length === 0 ? '<div style="text-align: center; padding: 3rem; color: var(--text-secondary);">No projects match the current filters. Add projects using the "+ Add to Timeline" button above.</div>' : ''}
                </div>
            `;
            
            timelineWrapper.innerHTML = timelineHTML;
            updateTimelineFilterDropdowns();
            
            const totalsHTML = renderTotalsTable();
            const totalsSection = document.createElement('div');
            totalsSection.innerHTML = totalsHTML;
            timelineWrapper.appendChild(totalsSection.firstChild);
        }

        function getFilteredTimelineProjects() {
            return APP.timelineProjects.filter((tp, index) => {
                const project = APP.projects.find(p => p.id === tp.projectId);
                if (!project) return false;
                
                if (APP.timelineFilters.categories.length > 0) {
                    const hasCategory = project.categories && 
                        project.categories.some(cat => APP.timelineFilters.categories.includes(cat));
                    if (!hasCategory) return false;
                }
                
                if (APP.timelineFilters.statuses.length > 0) {
                    if (!APP.timelineFilters.statuses.includes(project.status)) return false;
                }
                
                if (APP.timelineFilters.users.length > 0) {
                    const hasUser = project.users && project.users.length > 0 &&
                        project.users.some(user => APP.timelineFilters.users.includes(user));
                    if (!hasUser) return false;
                }
                
                return true;
            }).map((tp, filteredIndex) => {
                const originalIndex = APP.timelineProjects.indexOf(tp);
                return { ...tp, originalIndex };
            });
        }

        function renderTimelineProjectRow(timelineProjectData, displayIndex) {
            const timelineProject = timelineProjectData;
            const actualIndex = timelineProject.originalIndex !== undefined ? timelineProject.originalIndex : displayIndex;
            const project = APP.projects.find(p => p.id === timelineProject.projectId);
            if (!project) return '';
            
            const allocations = timelineProject.allocations || {};
            const startDate = timelineProject.startDate || null;
            const endDate = timelineProject.endDate || null;
            
            const currentYear = APP.timelineStartDate.getFullYear();
            const currentMonth = APP.timelineStartDate.getMonth();
            
            let ganttHTML = '<div style="color: var(--text-secondary); font-size: 0.75rem; padding: 0.5rem;">Click to set timeline</div>';
            
            if (startDate && endDate) {
                const startDateObj = new Date(startDate);
                const endDateObj = new Date(endDate);
                
                const timelineStart = new Date(currentYear, currentMonth, 1);
                
                const startPosition = dateToMonthPosition(startDateObj, timelineStart);
                const endPosition = dateToMonthPosition(endDateObj, timelineStart);
                
                const leftPercent = (startPosition / APP.timelineMonthsToShow) * 100;
                const widthPercent = ((endPosition - startPosition) / APP.timelineMonthsToShow) * 100;
                
                if (leftPercent < 100 && leftPercent + widthPercent > 0) {
                    const clampedLeft = Math.max(0, leftPercent);
                    const clampedWidth = Math.min(100 - clampedLeft, widthPercent + Math.min(0, leftPercent));
                    
                    const label = formatDateRangeLabel(startDateObj, endDateObj);
                    
                    ganttHTML = `
                        <div class="timeline-gantt-bar" 
                             style="left: ${clampedLeft}%; width: ${clampedWidth}%;"
                             data-project-index="${actualIndex}">
                            <div class="timeline-gantt-handle timeline-gantt-handle-left" 
                                 onmousedown="startGanttDrag(event, ${actualIndex}, 'resize-left')"></div>
                            <div class="timeline-gantt-bar-body"
                                 onmousedown="startGanttDrag(event, ${actualIndex}, 'move')">
                                ${label}
                            </div>
                            <div class="timeline-gantt-handle timeline-gantt-handle-right" 
                                 onmousedown="startGanttDrag(event, ${actualIndex}, 'resize-right')"></div>
                        </div>
                    `;
                }
            }
            
            return `
                <div class="timeline-project-row" data-project-index="${actualIndex}">
                    <div class="timeline-project-info" onclick="openAllocationModal(${actualIndex})">
                        <div class="timeline-project-title">${project.title}</div>
                        <div class="timeline-project-users">
                            ${project.users && project.users.length > 0 ? project.users.join(', ') : 'No users assigned'}
                        </div>
                    </div>
                    <div class="timeline-gantt-container" onclick="handleGanttContainerClick(event, ${actualIndex})">
                        ${ganttHTML}
                    </div>
                    <button onclick="removeTimelineProject(${actualIndex})" style="padding: 0.5rem; background: var(--pastel-red); color: var(--bg-primary); border: none; border-radius: 6px; font-size: 0.75rem; cursor: pointer; font-weight: 500; white-space: nowrap;">Remove</button>
                </div>
            `;
        }

        function dateToMonthPosition(date, timelineStart) {
            const year = date.getFullYear();
            const monthIndex = date.getMonth();
            const day = 1 // date.getDate();
            
            const monthsFromTimeline = (year - timelineStart.getFullYear()) * 12 + (monthIndex - timelineStart.getMonth());
            
            let quarterPosition = 0;
            if (day === 1) {
                quarterPosition = 0;
            } else if (day === 8) {
                quarterPosition = 0.25;
            } else if (day === 15) {
                quarterPosition = 0.5;
            } else if (day === 23) {
                quarterPosition = 0.75;
            } else {
                quarterPosition = 1;
            }
            
            return monthsFromTimeline + quarterPosition;
        }

        function formatDateRangeLabel(startDate, endDate) {
            const startMonth = startDate.toLocaleDateString('en-US', { month: 'short' });
            const startDay = startDate.getDate();
            const endMonth = endDate.toLocaleDateString('en-US', { month: 'short' });
            const endDay = endDate.getDate();
            
            const startYear = startDate.getFullYear();
            const endYear = endDate.getFullYear();
            const startMonthIndex = startDate.getMonth();
            const endMonthIndex = endDate.getMonth();
            
            const getQuarterLabel = (monthName, day) => {
                if (day === 1) return monthName;
                if (day === 8) return `Early ${monthName}`;
                if (day === 15) return `Mid ${monthName}`;
                if (day === 23) return `Late ${monthName}`;
                return monthName;
            };
            
            // Calculate the actual end position (endDate with day 1 means end of previous month)
            let actualEndMonth = endMonthIndex;
            let actualEndDay = endDay;
            
            if (endDay === 1) {
                actualEndMonth = endMonthIndex - 1;
                if (actualEndMonth < 0) {
                    actualEndMonth = 11;
                }
                actualEndDay = 1;
            }
            
            const actualEndDate = endDay === 1 ? new Date(endYear, actualEndMonth, 1) : endDate;
            const actualEndMonthName = actualEndDate.toLocaleDateString('en-US', { month: 'short' });
            
            // Same month scenarios
            if (startYear === endYear && startMonthIndex === actualEndMonth) {
                // If within same month, just show the month name
                return startMonth;
            }
            
            // Different months - show range
            const startLabel = getQuarterLabel(startMonth, startDay);
            const endLabel = getQuarterLabel(actualEndMonthName, actualEndDay);
            
            // Don't show range if start and end are the same
            if (startLabel === endLabel) {
                return startLabel;
            }
            
            return `${startLabel} - ${endLabel}`;
        }

        function handleGanttContainerClick(event, projectIndex) {
            const target = event.target;
            if (target.classList.contains('timeline-gantt-container')) {
                const rect = target.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const percentX = (clickX / rect.width) * 100;
                
                const monthClicked = Math.floor((percentX / 100) * APP.timelineMonthsToShow);
                
                const currentYear = APP.timelineStartDate.getFullYear();
                const currentMonth = APP.timelineStartDate.getMonth();
                
                const startDate = new Date(currentYear, currentMonth + monthClicked, 1);
                const endDate = new Date(currentYear, currentMonth + monthClicked + 1, 1);
                
                const timelineProject = APP.timelineProjects[projectIndex];
                if (timelineProject) {
                    timelineProject.startDate = startDate.toISOString();
                    timelineProject.endDate = endDate.toISOString();
                    saveToLocalStorage();
                    renderTimeline();
                }
            }
        }

        function openAllocationModal(projectIndex) {
            const timelineProject = APP.timelineProjects[projectIndex];
            if (!timelineProject) return;
            
            const project = APP.projects.find(p => p.id === timelineProject.projectId);
            if (!project) return;
            
            const allocations = timelineProject.allocations || {};
            
            const modal = document.createElement('div');
            modal.id = 'allocationModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Edit Allocations - ${project.title}</h2>
                        <button class="close-btn" onclick="closeAllocationModal()">&times;</button>
                    </div>
                    ${project.users && project.users.length > 0 ? `
                        <div class="form-group">
                            <label class="form-label">User Allocations (%)</label>
                            ${project.users.map(user => `
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                                    <label style="flex: 1; color: var(--text-primary);">${user}</label>
                                    <input 
                                        type="number" 
                                        class="form-input" 
                                        id="alloc-${user}"
                                        value="${allocations[user] || 0}" 
                                        min="0" 
                                        max="100"
                                        style="width: 100px;"
                                    >
                                    <span style="color: var(--text-secondary);">%</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="color: var(--text-secondary);">No users assigned to this project.</p>'}
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                        <button class="btn-primary" onclick="closeAllocationModal()" style="background: var(--bg-secondary); border: 1px solid var(--pastel-red); color: var(--pastel-red); font-weight: 500;">Cancel</button>
                        <button class="btn-save" onclick="saveAllocations(${projectIndex})">Save Allocations</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
        }

        function closeAllocationModal() {
            const modal = document.getElementById('allocationModal');
            if (modal) modal.remove();
        }

        function saveAllocations(projectIndex) {
            const timelineProject = APP.timelineProjects[projectIndex];
            if (!timelineProject) return;
            
            const project = APP.projects.find(p => p.id === timelineProject.projectId);
            if (!project || !project.users) return;
            
            project.users.forEach(user => {
                const input = document.getElementById(`alloc-${user}`);
                if (input) {
                    const value = parseInt(input.value) || 0;
                    const clampedValue = Math.max(0, Math.min(100, value));
                    
                    if (!timelineProject.allocations) {
                        timelineProject.allocations = {};
                    }
                    timelineProject.allocations[user] = clampedValue;
                }
            });
            
            saveToLocalStorage();
            renderTimeline();
            closeAllocationModal();
            showNotification('Allocations saved successfully', 'success');
        }

        function startGanttDrag(event, projectIndex, dragType) {
            event.stopPropagation();
            event.preventDefault();
            
            const timelineProject = APP.timelineProjects[projectIndex];
            if (!timelineProject) return;
            
            // store initial drag state and month-position equivalents
            const currentYear = APP.timelineStartDate.getFullYear();
            const currentMonth = APP.timelineStartDate.getMonth();
            const timelineStart = new Date(currentYear, currentMonth, 1);

            const originalStart = timelineProject.startDate ? new Date(timelineProject.startDate) : new Date(timelineStart);
            const originalEnd = timelineProject.endDate ? new Date(timelineProject.endDate) : new Date(timelineStart.getFullYear(), timelineStart.getMonth() + 1, 1);

            APP.isDraggingGantt = true;
            APP.ganttDragData = {
                projectIndex: projectIndex,
                dragType: dragType,
                startX: event.clientX,
                containerRect: event.target.closest('.timeline-gantt-container')?.getBoundingClientRect(),
                originalStartDate: originalStart.toISOString(),
                originalEndDate: originalEnd.toISOString(),
                originalStartPos: getMonthPositionFromDate(originalStart, timelineStart),
                originalEndPos: getMonthPositionFromDate(originalEnd, timelineStart)
            };
            
            const bar = event.target.closest('.timeline-gantt-bar');
            if (bar) bar.classList.add('dragging');
            
            document.addEventListener('mousemove', handleGanttDrag);
            document.addEventListener('mouseup', stopGanttDrag);
        }

        function handleGanttDrag(event) {
            if (!APP.isDraggingGantt || !APP.ganttDragData) return;
            
            event.preventDefault();
            
            
            // Use month-based positions and snap to quarter (0, .25, .5, .75)
            const row = document.querySelector(`.timeline-project-row[data-project-index="${APP.ganttDragData.projectIndex}"]`);
            if (!row) return;

            const ganttContainer = row.querySelector('.timeline-gantt-container');
            if (!ganttContainer) return;

            const rect = APP.ganttDragData.containerRect || ganttContainer.getBoundingClientRect();
            const containerWidth = rect.width;

            const deltaX = event.clientX - APP.ganttDragData.startX;
            const deltaMonths = (deltaX / containerWidth) * APP.timelineMonthsToShow;

            const timelineStart = new Date(APP.timelineStartDate.getFullYear(), APP.timelineStartDate.getMonth(), 1);
            const tp = APP.timelineProjects[APP.ganttDragData.projectIndex];

            // original positions (float months, e.g., 0.25 means first month + quarter)
            const origStartPos = APP.ganttDragData.originalStartPos;
            const origEndPos = APP.ganttDragData.originalEndPos;

            let newStartPos = origStartPos;
            let newEndPos = origEndPos;

            if (APP.ganttDragData.dragType === 'move') {
                newStartPos = origStartPos + deltaMonths;
                newEndPos = origEndPos + deltaMonths;

                // snap both to nearest quarter
                newStartPos = snapToQuarter(newStartPos);
                newEndPos = snapToQuarter(newEndPos);

                // preserve duration if snapping collapsed it
                if (newEndPos - newStartPos < 0.25) {
                    newEndPos = newStartPos + 0.25;
                }
            } else if (APP.ganttDragData.dragType === 'resize-left') {
                newStartPos = origStartPos + deltaMonths;
                newStartPos = snapToQuarter(newStartPos);

                // enforce minimum width
                if (origEndPos - newStartPos < 0.25) {
                    newStartPos = origEndPos - 0.25;
                }
            } else if (APP.ganttDragData.dragType === 'resize-right') {
                newEndPos = origEndPos + deltaMonths;
                newEndPos = snapToQuarter(newEndPos);

                if (newEndPos - origStartPos < 0.25) {
                    newEndPos = origStartPos + 0.25;
                }
            }

            // clamp to timeline range
            newStartPos = Math.max(0, Math.min(APP.timelineMonthsToShow - 0.25, newStartPos));
            newEndPos = Math.max(0.25, Math.min(APP.timelineMonthsToShow, newEndPos));

            // Update data model
            tp.startDate = getDateFromMonthPosition(newStartPos, timelineStart).toISOString();
            tp.endDate = getDateFromMonthPosition(newEndPos, timelineStart).toISOString();

            // Update visual bar
            const leftPercent = (newStartPos / APP.timelineMonthsToShow) * 100;
            const widthPercent = ((newEndPos - newStartPos) / APP.timelineMonthsToShow) * 100;
            const label = formatDateRangeLabel(new Date(tp.startDate), new Date(tp.endDate));

            const bar = ganttContainer.querySelector('.timeline-gantt-bar');
            if (bar) {
                bar.style.left = `${leftPercent}%`;
                bar.style.width = `${widthPercent}%`;
                const barBody = bar.querySelector('.timeline-gantt-bar-body');
                if (barBody) barBody.textContent = label;
            }
        }

        function getEndColumnFromDate(date, timelineStart) {
            // For end dates, if it's the 1st of the month, use previous month
            const adjustedDate = new Date(date);
            if (adjustedDate.getDate() === 1) {
                adjustedDate.setDate(0); // Last day of previous month
            }
            return getColumnFromDate(adjustedDate, timelineStart);
        }

        function monthPositionToDate(timelineStart, monthPosition) {
            const date = new Date(timelineStart);
            date.setMonth(date.getMonth() + Math.floor(monthPosition));
            date.setDate(1);
            return date;
        }

        function getMonthPositionFromDate(date, timelineStart) {
            // returns float months from timelineStart, with fractional quarters: 0, .25, .5, .75
            const yearDiff = date.getFullYear() - timelineStart.getFullYear();
            const monthDiff = date.getMonth() - timelineStart.getMonth();
            const monthsFromTimeline = yearDiff * 12 + monthDiff;

            const day = date.getDate();
            let frac = 0;
            if (day === 1) frac = 0;
            else if (day === 8) frac = 0.25;
            else if (day === 15) frac = 0.5;
            else if (day === 23) frac = 0.75;
            else {
                // snap other days to nearest quarter
                const approximate = (() => {
                    if (day <= 5) return 0;
                    if (day <= 11) return 0.25;
                    if (day <= 18) return 0.5;
                    if (day <= 26) return 0.75;
                    return 0; // push to next month
                })();
                frac = approximate;
                if (approximate === 0 && day > 26) {
                    // move to next month
                    return monthsFromTimeline + 1;
                }
            }

            return monthsFromTimeline + frac;
        }

        function getDateFromMonthPosition(monthPosition, timelineStart) {
            const whole = Math.floor(monthPosition);
            const frac = Math.round((monthPosition - whole) * 4) / 4;
            const date = new Date(timelineStart);
            date.setMonth(date.getMonth() + whole);
            if (frac === 0) date.setDate(1);
            else if (frac === 0.25) date.setDate(8);
            else if (frac === 0.5) date.setDate(15);
            else if (frac === 0.75) date.setDate(23);
            return date;
        }

        function snapToQuarter(value) {
            return Math.round(value * 4) / 4;
        }

        function stopGanttDrag(event) {
            if (!APP.isDraggingGantt) return;
            
            const bars = document.querySelectorAll('.timeline-gantt-bar');
            bars.forEach(bar => bar.classList.remove('dragging'));
            
            document.removeEventListener('mousemove', handleGanttDrag);
            document.removeEventListener('mouseup', stopGanttDrag);
            
            APP.isDraggingGantt = false;
            APP.ganttDragData = null;
            
            saveToLocalStorage();
            renderTimeline();
        }

        function updateTimelineAllocation(projectIndex, user, percentage) {
            const value = parseInt(percentage) || 0;
            const clampedValue = Math.max(0, Math.min(100, value));
            
            if (!APP.timelineProjects[projectIndex].allocations) {
                APP.timelineProjects[projectIndex].allocations = {};
            }
            
            APP.timelineProjects[projectIndex].allocations[user] = clampedValue;
            saveToLocalStorage();
        }

        function snapToHalfMonth(date) {
            const day = date.getDate();
            const snappedDate = new Date(date);
            
            if (day <= 5) {
                snappedDate.setDate(1);
            } else if (day <= 13) {
                snappedDate.setDate(8);
            } else if (day <= 21) {
                snappedDate.setDate(15);
            } else if (day <= 28) {
                snappedDate.setDate(23);
            } else {
                snappedDate.setMonth(snappedDate.getMonth() + 1);
                snappedDate.setDate(1);
            }
            
            snappedDate.setHours(0, 0, 0, 0);
            return snappedDate;
        }

        function renderTotalsTable() {
            const currentYear = APP.timelineStartDate.getFullYear();
            const currentMonth = APP.timelineStartDate.getMonth();
            
            const months = [];
            for (let i = 0; i < APP.timelineMonthsToShow; i++) {
                const date = new Date(currentYear, currentMonth + i, 1);
                months.push({
                    name: date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }),
                    date: date
                });
            }
            
            const userTotals = {};
            APP.users.forEach(user => {
                userTotals[user] = months.map(() => 0);
            });
            
            APP.timelineProjects.forEach(tp => {
                const project = APP.projects.find(p => p.id === tp.projectId);
                if (!project || !tp.startDate || !tp.endDate) return;
                
                const startDate = new Date(tp.startDate);
                const endDate = new Date(tp.endDate);
                
                months.forEach((month, idx) => {
                    const monthStart = new Date(month.date);
                    const monthEnd = new Date(monthStart.getFullYear(), monthStart.getMonth() + 1, 0);
                    
                    if (startDate <= monthEnd && endDate >= monthStart) {
                        if (project.users && project.users.length > 0) {
                            project.users.forEach(user => {
                                const allocation = (tp.allocations && tp.allocations[user]) || 0;
                                if (userTotals[user]) {
                                    userTotals[user][idx] += allocation;
                                }
                            });
                        }
                    }
                });
            });
            
            let tableHTML = `
                <div class="timeline-totals-section">
                    <div class="timeline-totals-title">Resource Allocation Summary</div>
                    <table class="timeline-totals-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                ${months.map(m => `<th>${m.name}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            Object.keys(userTotals).forEach(user => {
                tableHTML += '<tr>';
                tableHTML += `<td style="font-weight: 600; color: var(--text-primary);">${user}</td>`;
                
                userTotals[user].forEach(total => {
                    let className = '';
                    if (total > 100) className = 'timeline-totals-over';
                    else if (total === 100) className = 'timeline-totals-full';
                    
                    tableHTML += `<td class="${className}">${total}%</td>`;
                });
                
                tableHTML += '</tr>';
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return tableHTML;
        }

        function shiftTimelineBack() {
            const newDate = new Date(APP.timelineStartDate);
            newDate.setMonth(newDate.getMonth() - 1);
            APP.timelineStartDate = newDate;
            renderTimeline();
        }

        function shiftTimelineForward() {
            const newDate = new Date(APP.timelineStartDate);
            newDate.setMonth(newDate.getMonth() + 1);
            APP.timelineStartDate = newDate;
            renderTimeline();
        }

        function resetTimelineToToday() {
            APP.timelineStartDate = new Date();
            renderTimeline();
        }

        function changeTimelineMonths() {
            const select = document.getElementById('timelineMonthsSelect');
            APP.timelineMonthsToShow = parseInt(select.value);
            saveToLocalStorage();
            renderTimeline();
        }

        function showAddTimelineProjectMenu() {
            const availableProjects = APP.projects.filter(p => 
                !APP.timelineProjects.some(tp => tp.projectId === p.id)
            );
            
            if (availableProjects.length === 0) {
                showNotification('All projects are already on the timeline', 'info');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'addTimelineProjectModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Add Project to Timeline</h2>
                        <button class="close-btn" onclick="closeAddTimelineProjectModal()">&times;</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Select Project</label>
                        <select class="form-select" id="timelineProjectSelect">
                            ${availableProjects.map(p => 
                                `<option value="${p.id}">${p.title} (${p.users ? p.users.join(', ') : 'No users'})</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn-primary" onclick="closeAddTimelineProjectModal()" style="background: var(--bg-secondary); border: 1px solid var(--pastel-red); color: var(--pastel-red); font-weight: 500;">Cancel</button>
                        <button class="btn-save" onclick="addProjectToTimeline()">Add to Timeline</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
        }

        function closeAddTimelineProjectModal() {
            const modal = document.getElementById('addTimelineProjectModal');
            if (modal) modal.remove();
        }

        function addProjectToTimeline() {
            const select = document.getElementById('timelineProjectSelect');
            if (!select) return;
            
            const projectId = parseInt(select.value);
            const project = APP.projects.find(p => p.id === projectId);
            
            if (!project) return;
            
            const allocations = {};
            if (project.users && project.users.length > 0) {
                project.users.forEach(user => {
                    allocations[user] = 0;
                });
            }
            
            const currentDate = new Date(APP.timelineStartDate);
            currentDate.setDate(1);
            const startDate = new Date(currentDate);
            const endDate = new Date(currentDate);
            endDate.setMonth(endDate.getMonth() + 1);
            
            APP.timelineProjects.push({
                projectId: projectId,
                allocations: allocations,
                startDate: startDate.toISOString(),
                endDate: endDate.toISOString()
            });
            
            saveToLocalStorage();
            renderTimeline();
            closeAddTimelineProjectModal();
            showNotification(`Added "${project.title}" to timeline`, 'success');
        }

        function updateTimelineAllocation(projectIndex, user, percentage) {
            const value = parseInt(percentage) || 0;
            const clampedValue = Math.max(0, Math.min(100, value));
            
            if (!APP.timelineProjects[projectIndex].allocations) {
                APP.timelineProjects[projectIndex].allocations = {};
            }
            
            APP.timelineProjects[projectIndex].allocations[user] = clampedValue;
            saveToLocalStorage();
            showNotification(`Updated ${user}'s allocation to ${clampedValue}%`, 'success');
        }

        function removeTimelineProject(index) {
            const timelineProject = APP.timelineProjects[index];
            const project = APP.projects.find(p => p.id === timelineProject.projectId);
            
            if (!project) return;
            
            showConfirm(`Remove "${project.title}" from timeline?`, function() {
                APP.timelineProjects.splice(index, 1);
                saveToLocalStorage();
                renderTimeline();
                showNotification('Project removed from timeline', 'success');
            });
        }

        function switchNote() {
            saveCurrentNote();
            const selector = document.getElementById('notesSelector');
            APP.currentNoteName = selector.value;
            loadNotes();
        }
        
        function saveCurrentNote() {
            const textarea = document.getElementById('notesTextarea');
            const noteName = APP.currentNoteName;
            const noteKey = noteName.toLowerCase().replace(/\s+/g, '_');
            APP.notes[noteKey] = textarea.value;
            saveToLocalStorage();
        }
        
        function loadNotes() {
            const textarea = document.getElementById('notesTextarea');
            const selector = document.getElementById('notesSelector');
            
            if (!textarea || !selector) return;
            
            const noteName = APP.currentNoteName;
            const noteKey = noteName.toLowerCase().replace(/\s+/g, '_');
            textarea.value = APP.notes[noteKey] || '';
            selector.value = noteName;
        }
        
        function addNewNote() {
            const noteName = prompt('Enter note name:');
            if (!noteName || !noteName.trim()) return;
            
            const trimmedName = noteName.trim();
            const noteKey = trimmedName.toLowerCase().replace(/\s+/g, '_');
            
            if (APP.notes[noteKey] !== undefined) {
                showNotification('A note with this name already exists', 'error');
                return;
            }
            
            APP.notes[noteKey] = '';
            
            const selector = document.getElementById('notesSelector');
            const option = document.createElement('option');
            option.value = trimmedName;
            option.textContent = trimmedName;
            selector.appendChild(option);
            
            APP.currentNoteName = trimmedName;
            selector.value = trimmedName;
            loadNotes();
            
            saveToLocalStorage();
            showNotification(`Note "${trimmedName}" created`, 'success');
        }

        function deleteCurrentNote() {
            const selector = document.getElementById('notesSelector');
            const currentNoteName = selector.value;
            const noteKey = currentNoteName.toLowerCase().replace(/\s+/g, '_');

            const defaultNotes = ['Nymbl', 'Cindy', 'Me'];
            if (defaultNotes.includes(currentNoteName)) {
                showNotification('Cannot delete default notes', 'error');
                return;
            }

            showConfirm(`Delete note "${currentNoteName}"? This action cannot be undone.`, function() {
                delete APP.notes[noteKey];

                const optionToRemove = Array.from(selector.options).find(opt => opt.value === currentNoteName);
                if (optionToRemove) {
                    selector.removeChild(optionToRemove);
                }

                APP.currentNoteName = 'Nymbl';
                selector.value = 'Nymbl';
                loadNotes();

                saveToLocalStorage();
                showNotification('Note deleted successfully', 'success');
            });
        }

        function handleNotesInput(e) {
            const textarea = e.target;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            
            let value = textarea.value;
            let newValue = value.replace(/^-\s/gm, '• ');
            
            if (value !== newValue) {
                const beforeCursor = value.substring(0, start);
                const beforeCursorNew = beforeCursor.replace(/^-\s/gm, '• ');
                const diff = beforeCursorNew.length - beforeCursor.length;
                
                textarea.value = newValue;
                textarea.selectionStart = start + diff;
                textarea.selectionEnd = end + diff;
            }
            
            saveCurrentNote();
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            
            setTimeout(() => {
                if (container.contains(notification)) {
                    container.removeChild(notification);
                }
            }, 3000);
        }

        function showConfirm(message, onConfirm) {
            const confirmDiv = document.createElement('div');
            confirmDiv.id = 'confirmDialog';
            confirmDiv.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 9999;';
            confirmDiv.innerHTML = `
                <div style="background: rgba(35, 35, 38, 0.98); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 12px; padding: 2rem; max-width: 400px; box-shadow: var(--shadow);">
                    <p style="margin-bottom: 1.5rem; color: var(--text-primary);">${message}</p>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="cancelConfirm()" style="padding: 0.5rem 1.5rem; background: var(--bg-secondary); border: 1px solid var(--pastel-red); color: var(--pastel-red); border-radius: 6px; cursor: pointer; font-weight: 500;">Cancel</button>
                        <button onclick="acceptConfirm()" style="padding: 0.5rem 1.5rem; background: var(--pastel-green); color: var(--bg-primary); border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Confirm</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDiv);
            
            window.acceptConfirm = function() {
                confirmDiv.remove();
                if (onConfirm) onConfirm();
            };
            
            window.cancelConfirm = function() {
                confirmDiv.remove();
            };
        }

        function markComplete(id) {
            const project = APP.projects.find(p => p.id === id);
            if (!project) return;
            
            showConfirm(`Mark "${project.title}" as complete?`, function() {
                project.status = 'complete';
                
                saveToLocalStorage();
                updateStats();
                renderProjects();
                if (APP.currentPage === 'timeline') {
                    renderTimeline();
                }
                showNotification('Project marked as complete', 'success');
            });
        }

        function deleteProject(id) {
            const project = APP.projects.find(p => p.id === id);
            if (!project) return;
            
            showConfirm(`Delete project "${project.title}"? This action cannot be undone.`, function() {
                APP.projects = APP.projects.filter(p => p.id !== id);
                
                saveToLocalStorage();
                updateStats();
                renderProjects();
                if (APP.currentPage === 'timeline') {
                    renderTimeline();
                }
                showNotification('Project deleted successfully', 'success');
            });
        }

        function openCreateModal() {
            if (APP.categories.length === 0) {
                showNotification('Please upload a PKD file first or add categories in Manage Settings', 'error');
                return;
            }
            
            APP.currentEditingProject = null;
            APP.currentProjectLinks = [];
            
            const modal = createEditModal();
            document.body.appendChild(modal);
            
            const maxId = APP.projects.length > 0 ? Math.max(...APP.projects.map(p => p.id)) + 1 : 1;
            document.getElementById('projectIdInput').value = maxId;
            
            const maxPriority = APP.projects.length > 0 ? Math.max(...APP.projects.map(p => p.priority || 999)) + 1 : 1;
            document.getElementById('projectPriorityInput').value = maxPriority;
            
            const statusSelect = document.getElementById('projectStatusSelect');
            if (APP.statuses.includes('idea')) {
                statusSelect.value = 'idea';
            } else if (APP.statuses.length > 0) {
                statusSelect.value = APP.statuses[0];
            }
            
            modal.style.display = 'block';
        }

        function openEditModal(id) {
            APP.currentEditingProject = id;
            const project = APP.projects.find(p => p.id === id);
            if (!project) return;
            
            APP.currentProjectLinks = project.links ? [...project.links] : [];
            
            const modal = createEditModal();
            document.body.appendChild(modal);
            
            document.getElementById('projectIdInput').value = project.id;
            document.getElementById('projectTitleInput').value = project.title;
            document.getElementById('projectStatusSelect').value = project.status;
            document.getElementById('projectPriorityInput').value = project.priority || 999;
            document.getElementById('projectDetailsInput').value = project.keyDetails || '';
            document.getElementById('projectNextStepsInput').value = project.nextSteps || '';
            
            if (project.categories) {
                project.categories.forEach(cat => {
                    const checkbox = document.getElementById(`cat-check-${cat}`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            if (project.users && project.users.length > 0) {
                project.users.forEach(user => {
                    const checkbox = document.getElementById(`user-check-${user}`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            updateLinksDisplay();
            modal.style.display = 'block';
        }

        function createEditModal() {
            const existing = document.getElementById('editModal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'editModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>${APP.currentEditingProject ? 'Edit Project' : 'Create New Project'}</h2>
                        <button class="close-btn" onclick="closeEditModal()">&times;</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project ID</label>
                        <input type="text" class="form-input" id="projectIdInput" disabled>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority (lower numbers appear first)</label>
                        <input type="number" class="form-input" id="projectPriorityInput" placeholder="1" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Title *</label>
                        <input type="text" class="form-input" id="projectTitleInput" placeholder="Enter project title">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="projectStatusSelect">
                            ${APP.statuses.length > 0 ? 
                                APP.statuses.map(s => `<option value="${s}">${s}</option>`).join('') :
                                '<option value="idea">idea</option>'}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Users</label>
                        <div id="userCheckboxes" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            ${APP.users.length > 0 ? 
                                APP.users.map(user => `
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="user-check-${user}" value="${user}">
                                        ${user}
                                    </label>
                                `).join('') :
                                '<span style="color: var(--text-secondary);">No users available</span>'}
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categories ${APP.categories.length === 0 ? '(Add categories in Manage Settings)' : '*'}</label>
                        <div id="categoryCheckboxes" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            ${APP.categories.length > 0 ? 
                                APP.categories.map(cat => `
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="cat-check-${cat}" value="${cat}">
                                        ${cat}
                                    </label>
                                `).join('') :
                                '<span style="color: var(--text-secondary);">No categories available</span>'}
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Key Details</label>
                        <textarea class="form-textarea" id="projectDetailsInput" placeholder="Enter key details..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Next Steps</label>
                        <textarea class="form-textarea" id="projectNextStepsInput" placeholder="Enter next steps..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Links</label>
                        <div id="projectLinksDisplay" style="margin-bottom: 1rem;"></div>
                        <button class="btn-primary" onclick="addLink()" style="font-size: 0.875rem; padding: 0.5rem 1rem;">Add Link</button>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn-primary" onclick="closeEditModal()" style="background: var(--bg-secondary); border: 1px solid var(--pastel-red); color: var(--pastel-red); font-weight: 500;">Cancel</button>
                        <button class="btn-save" onclick="saveProject()">Save Project</button>
                    </div>
                </div>
            `;
            
            updateLinksDisplay();
            return modal;
        }

        function updateLinksDisplay() {
            const container = document.getElementById('projectLinksDisplay');
            if (!container) return;
            
            if (APP.currentProjectLinks.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); font-size: 0.875rem;">No links added</div>';
            } else {
                container.innerHTML = APP.currentProjectLinks.map((link, idx) => `
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <a href="${link.url}" target="_blank" style="color: var(--pastel-blue);">${link.alias}</a>
                        <button onclick="removeLink(${idx})" style="padding: 0.25rem 0.5rem; background: var(--pastel-red); color: var(--bg-primary); border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; font-weight: 500;">Remove</button>
                    </div>
                `).join('');
            }
        }

        function addLink() {
            const container = document.getElementById('projectLinksDisplay');
            if (!container) return;
            
            if (document.getElementById('linkAddForm')) return;
            
            const formDiv = document.createElement('div');
            formDiv.id = 'linkAddForm';
            formDiv.style.cssText = 'padding: 1rem; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 1rem;';
            formDiv.innerHTML = `
                <div style="margin-bottom: 0.5rem;">
                    <input type="text" id="linkAliasInput" placeholder="Display text" style="width: 100%; padding: 0.5rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); margin-bottom: 0.5rem;">
                    <input type="url" id="linkUrlInput" placeholder="https://example.com" style="width: 100%; padding: 0.5rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary);">
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="saveLinkFromForm()" style="padding: 0.5rem 1rem; background: var(--pastel-green); color: var(--bg-primary); border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">Save</button>
                    <button onclick="cancelLinkForm()" style="padding: 0.5rem 1rem; background: var(--bg-secondary); border: 1px solid var(--pastel-red); color: var(--pastel-red); border-radius: 4px; cursor: pointer; font-weight: 500;">Cancel</button>
                </div>
            `;
            
            container.parentNode.insertBefore(formDiv, container);
        }
        
        function saveLinkFromForm() {
            const aliasInput = document.getElementById('linkAliasInput');
            const urlInput = document.getElementById('linkUrlInput');
            
            if (!aliasInput || !urlInput) return;
            
            const alias = aliasInput.value.trim();
            const url = urlInput.value.trim();
            
            if (!alias || !url) {
                showNotification('Please enter both display text and URL', 'error');
                return;
            }
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showNotification('URL must start with http:// or https://', 'error');
                return;
            }
            
            APP.currentProjectLinks.push({ alias, url });
            updateLinksDisplay();
            
            const form = document.getElementById('linkAddForm');
            if (form) form.remove();
            
            showNotification('Link added successfully', 'success');
        }
        
        function cancelLinkForm() {
            const form = document.getElementById('linkAddForm');
            if (form) form.remove();
        }

        function removeLink(index) {
            APP.currentProjectLinks.splice(index, 1);
            updateLinksDisplay();
            showNotification('Link removed', 'success');
        }

        function saveProject() {
            const id = parseInt(document.getElementById('projectIdInput').value);
            const priority = parseInt(document.getElementById('projectPriorityInput').value) || 999;
            const title = document.getElementById('projectTitleInput').value.trim();
            const status = document.getElementById('projectStatusSelect').value;
            const keyDetails = document.getElementById('projectDetailsInput').value.trim();
            const nextSteps = document.getElementById('projectNextStepsInput').value.trim();
            
            const categories = [];
            document.querySelectorAll('#categoryCheckboxes input:checked').forEach(cb => {
                categories.push(cb.value);
            });
            
            const users = [];
            document.querySelectorAll('#userCheckboxes input:checked').forEach(cb => {
                users.push(cb.value);
            });
            
            if (!title) {
                showNotification('Please enter a project title', 'error');
                return;
            }
            
            if (categories.length === 0) {
                showNotification('Please select at least one category', 'error');
                return;
            }
            
            const projectData = {
                id,
                priority,
                title,
                status,
                users: users,
                categories,
                keyDetails,
                nextSteps,
                links: APP.currentProjectLinks
            };
            
            if (APP.currentEditingProject) {
                const index = APP.projects.findIndex(p => p.id === APP.currentEditingProject);
                if (index !== -1) {
                    APP.projects[index] = projectData;
                    showNotification('Project updated successfully', 'success');
                }
            } else {
                APP.projects.push(projectData);
                showNotification('Project created successfully', 'success');
            }
            
            const now = new Date();
            APP.lastUpdated = now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('lastUpdatedText').textContent = `Last Updated: ${APP.lastUpdated}`;
            
            saveToLocalStorage();
            updateStats();
            renderProjects();
            if (APP.currentPage === 'timeline') {
                renderTimeline();
            }
            closeEditModal();
        }

        function closeEditModal() {
            const modal = document.getElementById('editModal');
            if (modal) modal.remove();
        }

        function openProjectModal(id) {
            const project = APP.projects.find(p => p.id === id);
            if (!project) return;
            
            const modal = document.createElement('div');
            modal.id = 'projectModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>${project.title}</h2>
                        <button class="close-btn" onclick="closeProjectModal()">&times;</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project ID</label>
                        <div>${project.id}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <div>${project.priority || 999}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <div><span style="background: var(--pastel-blue); color: var(--bg-primary); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem; font-weight: 500;">${project.status}</span></div>
                    </div>
                    ${project.users && project.users.length > 0 ? `
                    <div class="form-group">
                        <label class="form-label">Assigned Users</label>
                        <div>${project.users.join(', ')}</div>
                    </div>
                    ` : ''}
                    <div class="form-group">
                        <label class="form-label">Categories</label>
                        <div>${project.categories ? project.categories.join(', ') : 'None'}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Key Details</label>
                        <div style="white-space: pre-wrap; line-height: 1.5;">${project.keyDetails || 'No details provided'}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Next Steps</label>
                        <div style="white-space: pre-wrap; line-height: 1.5;">${project.nextSteps || 'No next steps defined'}</div>
                    </div>
                    ${project.links && project.links.length > 0 ? `
                        <div class="form-group">
                            <label class="form-label">Links</label>
                            <div>
                                ${project.links.map(link => 
                                    `<div style="margin-bottom: 0.5rem;"><a href="${link.url}" target="_blank" style="color: var(--pastel-blue);">${link.alias}</a></div>`
                                ).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
        }

        function closeProjectModal() {
            const modal = document.getElementById('projectModal');
            if (modal) modal.remove();
        }

        function openManageModal() {
            const modal = document.createElement('div');
            modal.id = 'manageModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Manage Settings</h2>
                        <button class="close-btn" onclick="closeManageModal()">&times;</button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Categories</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="text" class="form-input" id="newCategoryInput" placeholder="Enter category name" style="flex: 1;">
                            <button class="btn-save" onclick="addCategory()">Add</button>
                        </div>
                        <div id="categoriesList">
                            ${APP.categories.map((cat, idx) => `
                                <div class="settings-list-item">
                                    <span class="drag-handle">≡</span>
                                    <input type="text" id="cat-edit-${idx}" value="${cat}" style="flex: 1; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.25rem 0.5rem; color: var(--text-primary);">
                                    <button onclick="deleteCategory('${cat.replace(/'/g, "\\'")}')" style="padding: 0.25rem 0.5rem; background: var(--pastel-red); color: var(--bg-primary); border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; font-weight: 500;">Delete</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Statuses</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="text" class="form-input" id="newStatusInput" placeholder="Enter status name" style="flex: 1;">
                            <button class="btn-save" onclick="addStatus()">Add</button>
                        </div>
                        <div id="statusesList">
                            ${APP.statuses.map((status, idx) => `
                                <div class="settings-list-item">
                                    <span class="drag-handle">≡</span>
                                    <input type="text" id="status-edit-${idx}" value="${status}" style="flex: 1; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.25rem 0.5rem; color: var(--text-primary);">
                                    <button onclick="deleteStatus('${status}')" style="padding: 0.25rem 0.5rem; background: var(--pastel-red); color: var(--bg-primary); border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; font-weight: 500;">Delete</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Users</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="text" class="form-input" id="newUserInput" placeholder="Enter user name" style="flex: 1;">
                            <button class="btn-save" onclick="addUser()">Add</button>
                        </div>
                        <div id="usersList">
                            ${APP.users.map((user, idx) => `
                                <div class="settings-list-item">
                                    <span class="drag-handle">≡</span>
                                    <input type="text" id="user-edit-${idx}" value="${user}" style="flex: 1; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.25rem 0.5rem; color: var(--text-primary);">
                                    <button onclick="deleteUser('${user.replace(/'/g, "\\'")}')" style="padding: 0.25rem 0.5rem; background: var(--pastel-red); color: var(--bg-primary); border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; font-weight: 500;">Delete</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
        }

        function closeManageModal() {
            const modal = document.getElementById('manageModal');
            if (modal) modal.remove();
        }

        function addCategory() {
            const input = document.getElementById('newCategoryInput');
            const category = input.value.trim();
            
            if (!category) {
                showNotification('Please enter a category name', 'error');
                return;
            }
            
            if (APP.categories.includes(category)) {
                showNotification('This category already exists', 'error');
                return;
            }
            
            APP.categories.push(category);
            saveToLocalStorage();
            updateFilterDropdowns();
            closeManageModal();
            setTimeout(() => openManageModal(), 100);
            showNotification('Category added successfully', 'success');
        }

        function deleteCategory(category) {
            showConfirm(`Delete category "${category}"? This will remove it from all projects.`, function() {
                APP.categories = APP.categories.filter(c => c !== category);
                APP.projects.forEach(p => {
                    if (p.categories) {
                        p.categories = p.categories.filter(c => c !== category);
                    }
                });
                saveToLocalStorage();
                updateFilterDropdowns();
                renderProjects();
                closeManageModal();
                setTimeout(() => openManageModal(), 100);
                showNotification('Category deleted successfully', 'success');
            });
        }

        function addStatus() {
            const input = document.getElementById('newStatusInput');
            const status = input.value.trim().toLowerCase().replace(/\s+/g, '-');
            
            if (!status) {
                showNotification('Please enter a status name', 'error');
                return;
            }
            
            if (APP.statuses.includes(status)) {
                showNotification('This status already exists', 'error');
                return;
            }
            
            APP.statuses.push(status);
            saveToLocalStorage();
            updateFilterDropdowns();
            closeManageModal();
            setTimeout(() => openManageModal(), 100);
            showNotification('Status added successfully', 'success');
        }

        function deleteStatus(status) {
            showConfirm(`Delete status "${status}"? Projects with this status will be set to "idea".`, function() {
                APP.statuses = APP.statuses.filter(s => s !== status);
                APP.projects.forEach(p => {
                    if (p.status === status) p.status = 'idea';
                });
                saveToLocalStorage();
                updateFilterDropdowns();
                renderProjects();
                closeManageModal();
                setTimeout(() => openManageModal(), 100);
                showNotification('Status deleted successfully', 'success');
            });
        }

        function addUser() {
            const input = document.getElementById('newUserInput');
            const user = input.value.trim();
            
            if (!user) {
                showNotification('Please enter a user name', 'error');
                return;
            }
            
            if (APP.users.includes(user)) {
                showNotification('This user already exists', 'error');
                return;
            }
            
            APP.users.push(user);
            saveToLocalStorage();
            updateFilterDropdowns();
            closeManageModal();
            setTimeout(() => openManageModal(), 100);
            showNotification('User added successfully', 'success');
        }

        function deleteUser(user) {
            showConfirm(`Delete user "${user}"? This will remove them from all projects.`, function() {
                APP.users = APP.users.filter(u => u !== user);
                APP.projects.forEach(p => {
                    if (p.users && p.users.length > 0) {
                        p.users = p.users.filter(u => u !== user);
                    }
                });
                saveToLocalStorage();
                updateFilterDropdowns();
                renderProjects();
                closeManageModal();
                setTimeout(() => openManageModal(), 100);
                showNotification('User deleted successfully', 'success');
            });
        }

        function exportPKD() {
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            let content = `**Project Knowledge Document**\n\n`;
            content += `*Last Updated: ${dateStr}*\n\n`;
            content += `**Quick Reference List**\n\n`;
            
            APP.projects.forEach((project, index) => {
                content += `${index + 1}.  ${project.title}\n\n`;
            });
            
            if (APP.users.length > 0) {
                content += `**Users List**\n\n`;
                APP.users.forEach(user => {
                    content += `-   ${user}\n`;
                });
                content += `\n`;
            }
            
            content += `**Active Projects**\n\n`;
            
            APP.projects.forEach(project => {
                content += `**${project.id}. ${project.title}**\n\n`;
                content += `-   **Status**: ${project.status}\n\n`;
                content += `-   **Priority**: ${project.priority || 999}\n\n`;
                content += `-   **Project Category**: ${project.categories ? project.categories.join(', ') : ''}\n\n`;
                if (project.users && project.users.length > 0) {
                    content += `-   **Users**: ${project.users.join(', ')}\n\n`;
                }
                
                content += `-   **Key Details**: `;
                if (project.keyDetails && project.keyDetails.trim()) {
                    const detailLines = project.keyDetails.split('\n');
                    if (detailLines.length === 1) {
                        content += `${project.keyDetails}\n\n`;
                    } else {
                        content += `\n`;
                        detailLines.forEach((line) => {
                            content += `    ${line}\n`;
                        });
                        content += '\n';
                    }
                } else {
                    content += '\n\n';
                }
                
                content += `-   **Next Steps**: `;
                if (project.nextSteps && project.nextSteps.trim()) {
                    const stepLines = project.nextSteps.split('\n');
                    if (stepLines.length === 1) {
                        content += `${project.nextSteps}\n\n`;
                    } else {
                        content += `\n`;
                        stepLines.forEach((line) => {
                            content += `    ${line}\n`;
                        });
                        content += '\n';
                    }
                } else {
                    content += '\n\n';
                }
                
                if (project.links && project.links.length > 0) {
                    content += `-   **Links**: `;
                    project.links.forEach((link, idx) => {
                        if (idx > 0) content += ', ';
                        content += `[${link.alias}](${link.url})`;
                    });
                    content += '\n\n';
                }
            });
            
            content += `**Notes**\n\n`;
            
            const noteNames = Object.keys(APP.notes);
            const displayNoteNames = {
                'nymbl': 'Nymbl',
                'cindy': 'Cindy',
                'me': 'Personal'
            };
            
            noteNames.forEach(noteKey => {
                const displayName = displayNoteNames[noteKey] || 
                    noteKey.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                
                content += `**${displayName} Notes:**\n`;
                if (APP.notes[noteKey] && APP.notes[noteKey].trim()) {
                    const noteLines = APP.notes[noteKey].split('\n');
                    noteLines.forEach(line => {
                        content += `${line}\n`;
                    });
                } else {
                    content += `(No notes)\n`;
                }
                content += '\n';
            });
            
            content += `**Weekly Review Checklist**\n\n`;
            content += `-   [ ] Update project statuses\n\n`;
            content += `-   [ ] Review blockers and dependencies\n\n`;
            content += `-   [ ] Check upcoming deadlines\n\n`;
            content += `-   [ ] Update team member progress\n\n`;
            content += `-   [ ] Document completed milestones\n\n`;
            content += `-   [ ] Plan next week's priorities\n\n`;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `PKD_${today.getFullYear()}_${(today.getMonth() + 1).toString().padStart(2, '0')}_${today.getDate().toString().padStart(2, '0')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            APP.lastUpdated = dateStr;
            document.getElementById('lastUpdatedText').textContent = `Last Updated: ${APP.lastUpdated}`;
            saveToLocalStorage();
            showNotification('PKD exported successfully', 'success');
        }

        function parsePKDContent(content) {
            const result = {
                projects: [],
                categories: [],
                statuses: [],
                users: [],
                lastUpdated: 'Never',
                notes: {
                    nymbl: '',
                    cindy: '',
                    me: ''
                }
            };
            
            const categoriesSet = new Set();
            const statusesSet = new Set();
            const usersSet = new Set();
            
            const lines = content.split('\n');
            
            for (let i = 0; i < Math.min(lines.length, 10); i++) {
                const line = lines[i];
                if (line.includes('Last Updated:')) {
                    const match = line.match(/\*Last Updated:\s*(.+?)\*/);
                    if (match) {
                        result.lastUpdated = match[1].trim();
                        break;
                    }
                }
            }
            
            const projectsStart = lines.findIndex(line => line.includes('**Active Projects**'));
            const notesStart = lines.findIndex(line => line.includes('**Notes**'));
            const usersStart = lines.findIndex(line => line.includes('**Users List**'));
            
            if (usersStart !== -1 && usersStart < projectsStart) {
                const usersEnd = projectsStart !== -1 ? projectsStart : lines.length;
                for (let i = usersStart + 1; i < usersEnd; i++) {
                    const line = lines[i].trim();
                    if (line.startsWith('-')) {
                        const user = line.replace(/^-\s*/, '').trim();
                        if (user && !line.includes('**')) {
                            usersSet.add(user);
                        }
                    }
                }
            }
            
            if (projectsStart === -1) {
                console.log('No Active Projects section found');
                return result;
            }
            
            let currentProject = null;
            const projectsEnd = notesStart !== -1 ? notesStart : lines.length;
            
            for (let i = projectsStart + 1; i < projectsEnd; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                
                const projectMatch = trimmedLine.match(/^\*\*(\d+)\.\s+(.+)\*\*$/);
                if (projectMatch) {
                    if (currentProject) {
                        result.projects.push(currentProject);
                    }
                    currentProject = {
                        id: parseInt(projectMatch[1]),
                        title: projectMatch[2],
                        status: 'idea',
                        users: [],
                        categories: [],
                        keyDetails: '',
                        nextSteps: '',
                        links: [],
                        priority: 999
                    };
                    continue;
                }
                
                if (!currentProject) continue;
                
                if (line.includes('**Status**:')) {
                    const parts = line.split('**Status**:');
                    if (parts.length > 1) {
                        const status = parts[1].trim().toLowerCase().replace(/\s+/g, '-');
                        currentProject.status = status;
                        statusesSet.add(status);
                    }
                }
                
                if (line.includes('**Priority**:')) {
                    const parts = line.split('**Priority**:');
                    if (parts.length > 1) {
                        const priority = parseInt(parts[1].trim());
                        if (!isNaN(priority)) {
                            currentProject.priority = priority;
                        }
                    }
                }
                
                if (line.includes('**Project Category**:')) {
                    const parts = line.split('**Project Category**:');
                    if (parts.length > 1) {
                        const cats = parts[1].trim();
                        if (cats) {
                            const categoryList = cats.split(',').map(c => c.trim()).filter(c => c);
                            currentProject.categories = categoryList;
                            categoryList.forEach(c => categoriesSet.add(c));
                        }
                    }
                }
                
                if (line.includes('**User**:') || line.includes('**Users**:')) {
                    const parts = line.includes('**Users**:') ? line.split('**Users**:') : line.split('**User**:');
                    if (parts.length > 1) {
                        const usersString = parts[1].trim();
                        if (usersString) {
                            const usersList = usersString.split(',').map(u => u.trim()).filter(u => u);
                            currentProject.users = usersList;
                            usersList.forEach(u => usersSet.add(u));
                        }
                    }
                }
                
                if (line.includes('**Key Details**:')) {
                    const parts = line.split('**Key Details**:');
                    if (parts.length > 1 && parts[1].trim()) {
                        currentProject.keyDetails = parts[1].trim();
                    } else {
                        const detailLines = [];
                        let j = i + 1;
                        while (j < projectsEnd && lines[j] && !lines[j].includes('**') && !lines[j].trim().startsWith('-')) {
                            if (lines[j].trim()) {
                                detailLines.push(lines[j].replace(/^    /, ''));
                            }
                            j++;
                        }
                        currentProject.keyDetails = detailLines.join('\n').trim();
                    }
                }
                
                if (line.includes('**Next Steps**:')) {
                    const parts = line.split('**Next Steps**:');
                    if (parts.length > 1 && parts[1].trim()) {
                        currentProject.nextSteps = parts[1].trim();
                    } else {
                        const stepLines = [];
                        let j = i + 1;
                        while (j < projectsEnd && lines[j] && !lines[j].includes('**') && !lines[j].trim().startsWith('-')) {
                            if (lines[j].trim()) {
                                stepLines.push(lines[j].replace(/^    /, ''));
                            }
                            j++;
                        }
                        currentProject.nextSteps = stepLines.join('\n').trim();
                    }
                }
                
                if (line.includes('**Links**:')) {
                    const parts = line.split('**Links**:');
                    if (parts.length > 1) {
                        const linksText = parts[1].trim();
                        const linkMatches = [...linksText.matchAll(/\[([^\]]+)\]\(([^)]+)\)/g)];
                        linkMatches.forEach(match => {
                            currentProject.links.push({ alias: match[1], url: match[2] });
                        });
                    }
                }
                
                if (line.includes('**Weekly Review Checklist**')) {
                    if (currentProject) {
                        result.projects.push(currentProject);
                    }
                    break;
                }
            }
            
            if (currentProject && !result.projects.find(p => p.id === currentProject.id)) {
                result.projects.push(currentProject);
            }
            
            if (notesStart !== -1) {
                let currentNote = null;
                let noteContent = {};
                
                noteContent.nymbl = [];
                noteContent.cindy = [];
                noteContent.me = [];
                
                for (let i = notesStart + 1; i < lines.length; i++) {
                    const line = lines[i];
                    
                    const noteHeaderMatch = line.match(/\*\*(.+?)\s+Notes:\*\*/);
                    if (noteHeaderMatch) {
                        const noteName = noteHeaderMatch[1];
                        if (noteName === 'Nymbl') {
                            currentNote = 'nymbl';
                        } else if (noteName === 'Cindy') {
                            currentNote = 'cindy';
                        } else if (noteName === 'Personal') {
                            currentNote = 'me';
                        } else {
                            const noteKey = noteName.toLowerCase().replace(/\s+/g, '_');
                            currentNote = noteKey;
                            if (!noteContent[noteKey]) {
                                noteContent[noteKey] = [];
                            }
                        }
                        continue;
                    } else if (line.includes('**Weekly Review Checklist**')) {
                        break;
                    } else if (line.startsWith('**') && line.endsWith('**') && !line.includes('Notes:')) {
                        currentNote = null;
                        continue;
                    }
                    
                    if (currentNote && !line.includes('(No notes)')) {
                        if (!noteContent[currentNote]) {
                            noteContent[currentNote] = [];
                        }
                        noteContent[currentNote].push(line);
                    }
                }
                
                Object.keys(noteContent).forEach(key => {
                    result.notes[key] = noteContent[key].join('\n').trim();
                });
            }
            
            result.categories = Array.from(categoriesSet).sort();
            result.statuses = Array.from(statusesSet).sort();
            result.users = Array.from(usersSet).sort();
            
            return result;
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const parsed = parsePKDContent(content);
                    
                    if (parsed.lastUpdated) {
                        APP.lastUpdated = parsed.lastUpdated;
                        document.getElementById('lastUpdatedText').textContent = `Last Updated: ${APP.lastUpdated}`;
                    }
                    
                    if (parsed.projects.length > 0) {
                        APP.projects = parsed.projects;
                        APP.categories = parsed.categories;
                        APP.statuses = parsed.statuses;
                        APP.users = parsed.users;
                        APP.notes = parsed.notes;
                        
                        const selector = document.getElementById('notesSelector');
                        if (selector) {
                            selector.innerHTML = '';
                            
                            const displayNames = {
                                'nymbl': 'Nymbl',
                                'cindy': 'Cindy',
                                'me': 'Me'
                            };
                            
                            Object.keys(APP.notes).forEach(noteKey => {
                                const option = document.createElement('option');
                                const displayName = displayNames[noteKey] || 
                                    noteKey.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                                option.value = displayName;
                                option.textContent = displayName;
                                selector.appendChild(option);
                            });
                            
                            if (Object.keys(APP.notes).length > 0) {
                                const firstNoteKey = Object.keys(APP.notes)[0];
                                const firstDisplayName = displayNames[firstNoteKey] || 
                                    firstNoteKey.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                                APP.currentNoteName = firstDisplayName;
                                loadNotes();
                            }
                        }
                        
                        saveToLocalStorage();
                        updateStats();
                        updateFilterDropdowns();
                        renderProjects();
                        
                        showNotification(`Loaded ${APP.projects.length} projects with ${APP.categories.length} categories and ${APP.users.length} users`, 'success');
                    } else {
                        showNotification('No projects found in file', 'error');
                    }
                } catch (error) {
                    console.error('Parse error:', error);
                    showNotification('Error parsing file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkPassword();
                    }
                });
                passwordInput.focus();
            }
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown-filter')) {
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        menu.classList.remove('open');
                    });
                }
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modals = document.querySelectorAll('.modal');
                    modals.forEach(modal => modal.remove());
                }
            });
        });
    </script>
</body>
</html>
