<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PKD Project Management Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-card: #242424;
            --bg-hover: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
            --border-color: #333333;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Password Screen */
        #passwordScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .password-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 3rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .password-logo {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 2rem;
        }

        .password-title {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .password-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .password-input {
            width: 100%;
            padding: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            text-align: center;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
        }

        .password-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .password-input.error {
            border-color: var(--accent-red);
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .password-error {
            color: var(--accent-red);
            font-size: 0.875rem;
            margin-bottom: 1rem;
            opacity: 0;
            height: 20px;
        }

        .password-error.show {
            opacity: 1;
        }

        .password-submit {
            width: 100%;
            padding: 1rem;
            background: var(--accent-blue);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
        }

        .password-submit:hover {
            background: #2563eb;
        }

        /* Main Dashboard */
        #dashboardWrapper {
            display: none;
            padding: 2rem;
        }

        .header {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn-primary {
            padding: 0.5rem 1rem;
            background: var(--accent-blue);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .dropdown-filter {
            position: relative;
        }

        .dropdown-button {
            padding: 0.75rem 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            min-width: 200px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
            box-shadow: var(--shadow);
            z-index: 50;
            max-height: 300px;
            overflow-y: auto;
        }

        .dropdown-menu.open {
            display: block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 4px;
        }

        .dropdown-item:hover {
            background: var(--bg-hover);
        }

        .dropdown-item input[type="checkbox"] {
            margin-right: 0.75rem;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toggle-switch {
            width: 48px;
            height: 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            position: relative;
        }

        .toggle-switch.active {
            background: var(--accent-blue);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .project-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            transition: box-shadow 0.3s;
        }

        .project-card:hover {
            box-shadow: var(--shadow);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .project-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
        }

        .project-title:hover {
            color: var(--accent-blue);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .project-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        .project-actions {
            display: flex;
            gap: 0.5rem;
        }

        .edit-btn, .complete-btn, .delete-btn {
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            border: none;
            transition: opacity 0.2s;
        }
        
        .edit-btn:hover, .complete-btn:hover, .delete-btn:hover {
            opacity: 0.8;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn-save {
            padding: 0.75rem 1.5rem;
            background: var(--accent-green);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }

        .btn-save:hover {
            opacity: 0.9;
        }

        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
        }

        .notification {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-color: var(--accent-green);
        }

        .notification.error {
            border-color: var(--accent-red);
        }

        .notification.info {
            border-color: var(--accent-blue);
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .projects-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Password Screen -->
    <div id="passwordScreen">
        <div class="password-container">
            <div class="password-logo">PKD Dashboard</div>
            <h2 class="password-title">Secure Access</h2>
            <p class="password-subtitle">Please enter your password to continue</p>
            <input type="password" class="password-input" id="passwordInput" placeholder="Enter password">
            <div class="password-error" id="passwordError">Incorrect password. Please try again.</div>
            <button class="password-submit" id="passwordSubmitBtn" onclick="checkPassword()">Access Dashboard</button>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboardWrapper">
        <header class="header">
            <div class="header-content">
                <h1 class="logo">PKD Dashboard</h1>
                <div class="header-actions">
                    <span id="lastUpdatedText">Last Updated: Never</span>
                    <button class="btn-primary" onclick="openCreateModal()">New Project</button>
                    <button class="btn-primary" onclick="openManageModal()">Manage Settings</button>
                    <button class="btn-primary" onclick="exportPKD()">Export PKD</button>
                    <button class="btn-primary" onclick="document.getElementById('fileInput').click()">Upload PKD</button>
                    <input type="file" id="fileInput" style="display: none;" accept=".txt" onchange="handleFileUpload(event)">
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Stats -->
            <div id="statsSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; text-align: center;">
                    <div style="font-size: 2rem; color: var(--accent-blue);" id="activeCount">0</div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Active Projects</div>
                </div>
                <div style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; text-align: center;">
                    <div style="font-size: 2rem; color: var(--accent-green);" id="completeCount">0</div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">Completed</div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="Search projects..." id="searchInput" oninput="renderProjects()">
                </div>
                
                <div class="dropdown-filter">
                    <button class="dropdown-button" onclick="toggleDropdown('categoryMenu')">
                        Categories <span id="categoryCount"></span>
                    </button>
                    <div class="dropdown-menu" id="categoryMenu"></div>
                </div>

                <div class="dropdown-filter">
                    <button class="dropdown-button" onclick="toggleDropdown('statusMenu')">
                        Statuses <span id="statusCount"></span>
                    </button>
                    <div class="dropdown-menu" id="statusMenu"></div>
                </div>

                <div class="toggle-container">
                    <label>Show Completed</label>
                    <div class="toggle-switch" id="showCompletedToggle" onclick="toggleCompleted()">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>

            <!-- Projects Grid -->
            <div class="projects-grid" id="projectsGrid"></div>
        </div>
    </div>

    <script>
        // Global state - starts completely empty
        const APP = {
            projects: [],
            categories: [],
            statuses: [],
            selectedCategories: [],
            selectedStatuses: [],
            showCompleted: false,
            lastUpdated: 'Never',
            currentEditingProject: null,
            currentProjectLinks: [],
            PASSWORD_HASH: 2147093827 // Hash for 'eCapital'
        };

        // Utility function to hash password
        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash;
        }

        // Password check function
        function checkPassword() {
            const input = document.getElementById('passwordInput');
            const error = document.getElementById('passwordError');
            const password = input.value;
            
            if (hashCode(password) === APP.PASSWORD_HASH) {
                document.getElementById('passwordScreen').style.display = 'none';
                document.getElementById('dashboardWrapper').style.display = 'block';
                initializeDashboard();
            } else {
                input.classList.add('error');
                error.classList.add('show');
                setTimeout(() => {
                    input.classList.remove('error');
                    error.classList.remove('show');
                }, 2000);
            }
        }

        // Initialize dashboard
        function initializeDashboard() {
            // Always start with clean slate - no localStorage loading
            APP.projects = [];
            APP.categories = [];
            APP.statuses = [];
            APP.selectedCategories = [];
            APP.selectedStatuses = [];
            APP.lastUpdated = 'Never';
            
            updateStats();
            updateFilterDropdowns();
            
            // Always show welcome message on start
            const grid = document.getElementById('projectsGrid');
            grid.innerHTML = '<div style="text-align: center; padding: 3rem; color: var(--text-secondary);"><h3>Welcome to PKD Dashboard</h3><p style="margin-top: 1rem;">Upload a PKD file to get started, or create your first project.</p></div>';
            
            document.getElementById('lastUpdatedText').textContent = `Last Updated: ${APP.lastUpdated}`;
        }

        // Save to localStorage (only called after user actions, not on init)
        function saveToLocalStorage() {
            if (typeof localStorage !== 'undefined') {
                const data = {
                    projects: APP.projects,
                    categories: APP.categories,
                    statuses: APP.statuses,
                    lastUpdated: APP.lastUpdated
                };
                try {
                    localStorage.setItem('pkdDashboardData', JSON.stringify(data));
                } catch (e) {
                    console.error('Error saving to localStorage:', e);
                }
            }
        }

        // Update statistics
        function updateStats() {
            const active = APP.projects.filter(p => p.status !== 'complete').length;
            const complete = APP.projects.filter(p => p.status === 'complete').length;
            
            document.getElementById('activeCount').textContent = active;
            document.getElementById('completeCount').textContent = complete;
        }

        // Update filter dropdowns
        function updateFilterDropdowns() {
            // Categories
            const categoryMenu = document.getElementById('categoryMenu');
            categoryMenu.innerHTML = '';
            APP.categories.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                const isChecked = APP.selectedCategories.includes(cat) ? 'checked' : '';
                item.innerHTML = `
                    <input type="checkbox" id="cat-${cat}" onchange="toggleCategory('${cat}')" ${isChecked}>
                    <label for="cat-${cat}">${cat}</label>
                `;
                categoryMenu.appendChild(item);
            });

            // Statuses
            const statusMenu = document.getElementById('statusMenu');
            statusMenu.innerHTML = '';
            APP.statuses.forEach(status => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                const isChecked = APP.selectedStatuses.includes(status) ? 'checked' : '';
                item.innerHTML = `
                    <input type="checkbox" id="status-${status}" onchange="toggleStatus('${status}')" ${isChecked}>
                    <label for="status-${status}">${status}</label>
                `;
                statusMenu.appendChild(item);
            });
        }

        // Toggle dropdown visibility
        function toggleDropdown(menuId) {
            const menu = document.getElementById(menuId);
            menu.classList.toggle('open');
        }

        // Toggle category filter
        function toggleCategory(category) {
            const index = APP.selectedCategories.indexOf(category);
            if (index > -1) {
                APP.selectedCategories.splice(index, 1);
            } else {
                APP.selectedCategories.push(category);
            }
            updateFilterCounts();
            renderProjects();
        }

        // Toggle status filter
        function toggleStatus(status) {
            const index = APP.selectedStatuses.indexOf(status);
            if (index > -1) {
                APP.selectedStatuses.splice(index, 1);
            } else {
                APP.selectedStatuses.push(status);
            }
            updateFilterCounts();
            renderProjects();
        }

        // Update filter counts
        function updateFilterCounts() {
            const catCount = document.getElementById('categoryCount');
            const statusCount = document.getElementById('statusCount');
            
            catCount.textContent = APP.selectedCategories.length > 0 ? `(${APP.selectedCategories.length})` : '';
            statusCount.textContent = APP.selectedStatuses.length > 0 ? `(${APP.selectedStatuses.length})` : '';
        }

        // Toggle completed projects visibility
        function toggleCompleted() {
            APP.showCompleted = !APP.showCompleted;
            const toggle = document.getElementById('showCompletedToggle');
            toggle.classList.toggle('active');
            renderProjects();
        }

        // Render projects
        function renderProjects() {
            const grid = document.getElementById('projectsGrid');
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = APP.projects.filter(project => {
                // Filter by completion status
                if (!APP.showCompleted && project.status === 'complete') return false;
                
                // Filter by categories
                if (APP.selectedCategories.length > 0) {
                    const hasCategory = project.categories && 
                        project.categories.some(cat => APP.selectedCategories.includes(cat));
                    if (!hasCategory) return false;
                }
                
                // Filter by statuses
                if (APP.selectedStatuses.length > 0) {
                    if (!APP.selectedStatuses.includes(project.status)) return false;
                }
                
                // Filter by search
                if (search) {
                    const searchInProject = 
                        project.title.toLowerCase().includes(search) ||
                        (project.keyDetails && project.keyDetails.toLowerCase().includes(search)) ||
                        (project.nextSteps && project.nextSteps.toLowerCase().includes(search));
                    if (!searchInProject) return false;
                }
                
                return true;
            });
            
            grid.innerHTML = '';
            
            if (filtered.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 3rem; color: var(--text-secondary);">No projects found. Upload a PKD file to get started.</div>';
                return;
            }
            
            filtered.forEach(project => {
                const card = createProjectCard(project);
                grid.appendChild(card);
            });
        }

        // Create project card element
        function createProjectCard(project) {
            const card = document.createElement('div');
            card.className = 'project-card';
            
            // Determine status color
            let statusColor = '--accent-blue';
            if (project.status === 'complete') statusColor = '--text-secondary';
            else if (project.status === 'on-hold') statusColor = '--accent-red';
            else if (project.status === 'qa' || project.status === 'in-qa') statusColor = '--accent-orange';
            else if (project.status === 'active' || project.status === 'active-development') statusColor = '--accent-green';
            else if (project.status === 'stable') statusColor = '--accent-purple';
            else if (project.status === 'in-progress') statusColor = '--accent-blue';
            else if (project.status === 'planning' || project.status === 'planning-phase') statusColor = '--text-secondary';
            else if (project.status === 'in-training') statusColor = '--accent-orange';
            
            card.innerHTML = `
                <div class="project-header">
                    <div>
                        <div class="project-title" onclick="openProjectModal(${project.id})">${project.title}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">ID: ${project.id}</div>
                    </div>
                    <span class="status-badge" style="background: var(${statusColor}); color: white;">${project.status}</span>
                </div>
                <div style="margin: 1rem 0; color: var(--text-secondary); font-size: 0.875rem;">
                    ${project.keyDetails ? project.keyDetails.substring(0, 100) + (project.keyDetails.length > 100 ? '...' : '') : 'No details'}
                </div>
                <div class="project-footer">
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        ${project.categories && project.categories.length > 0 ? project.categories.map(cat => 
                            `<span style="padding: 0.25rem 0.5rem; background: rgba(59, 130, 246, 0.2); border-radius: 6px; font-size: 0.75rem; color: var(--accent-blue);">${cat}</span>`
                        ).join('') : ''}
                    </div>
                    <div class="project-actions">
                        <button class="edit-btn" style="background: var(--accent-purple); color: white;" onclick="openEditModal(${project.id})">Edit</button>
                        ${project.status !== 'complete' ? 
                            `<button class="complete-btn" style="background: var(--accent-green); color: white;" onclick="markComplete(${project.id})">Complete</button>` : ''}
                        <button class="delete-btn" style="background: var(--accent-red); color: white;" onclick="deleteProject(${project.id})">Delete</button>
                    </div>
                </div>
            `;
            
            return card;
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            
            setTimeout(() => {
                if (container.contains(notification)) {
                    container.removeChild(notification);
                }
            }, 3000);
        }

        // Custom confirmation dialog
        function showConfirm(message, onConfirm) {
            const confirmDiv = document.createElement('div');
            confirmDiv.id = 'confirmDialog';
            confirmDiv.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999;';
            confirmDiv.innerHTML = `
                <div style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 2rem; max-width: 400px;">
                    <p style="margin-bottom: 1.5rem; color: var(--text-primary);">${message}</p>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="cancelConfirm()" style="padding: 0.5rem 1.5rem; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 6px; cursor: pointer;">Cancel</button>
                        <button onclick="acceptConfirm()" style="padding: 0.5rem 1.5rem; background: var(--accent-red); color: white; border: none; border-radius: 6px; cursor: pointer;">Confirm</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDiv);
            
            window.acceptConfirm = function() {
                confirmDiv.remove();
                if (onConfirm) onConfirm();
            };
            
            window.cancelConfirm = function() {
                confirmDiv.remove();
            };
        }

        // Mark project as complete
        function markComplete(id) {
            const project = APP.projects.find(p => p.id === id);
            if (!project) return;
            
            showConfirm(`Mark "${project.title}" as complete?`, function() {
                project.status = 'complete';
                saveToLocalStorage();
                updateStats();
                renderProjects();
                showNotification('Project marked as complete', 'success');
            });
        }

        // Delete project
        function deleteProject(id) {
            const project = APP.projects.find(p => p.id === id);
            if (!project) return;
            
            showConfirm(`Delete project "${project.title}"? This action cannot be undone.`, function() {
                APP.projects = APP.projects.filter(p => p.id !== id);
                saveToLocalStorage();
                updateStats();
                renderProjects();
                showNotification('Project deleted successfully', 'success');
            });
        }

        // Create/Edit modal functions
        function openCreateModal() {
            // Check if we have any categories
            if (APP.categories.length === 0) {
                showNotification('Please upload a PKD file first or add categories in Manage Settings', 'error');
                return;
            }
            
            APP.currentEditingProject = null;
            APP.currentProjectLinks = [];
            
            const modal = createEditModal();
            document.body.appendChild(modal);
            
            // Set initial values
            const maxId = APP.projects.length > 0 ? Math.max(...APP.projects.map(p => p.id)) + 1 : 1;
            document.getElementById('projectIdInput').value = maxId;
            
            // Set default status if we have statuses
            if (APP.statuses.length > 0) {
                document.getElementById('projectStatusSelect').value = APP.statuses[0];
            }
            
            modal.style.display = 'block';
        }

        function openEditModal(id) {
            APP.currentEditingProject = id;
            const project = APP.projects.find(p => p.id === id);
            if (!project) return;
            
            APP.currentProjectLinks = project.links ? [...project.links] : [];
            
            const modal = createEditModal();
            document.body.appendChild(modal);
            
            // Set values
            document.getElementById('projectIdInput').value = project.id;
            document.getElementById('projectTitleInput').value = project.title;
            document.getElementById('projectStatusSelect').value = project.status;
            document.getElementById('projectDetailsInput').value = project.keyDetails || '';
            document.getElementById('projectNextStepsInput').value = project.nextSteps || '';
            
            // Check the appropriate categories
            if (project.categories) {
                project.categories.forEach(cat => {
                    const checkbox = document.getElementById(`cat-check-${cat}`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            updateLinksDisplay();
            modal.style.display = 'block';
        }

        function createEditModal() {
            // Remove existing modal if present
            const existing = document.getElementById('editModal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'editModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>${APP.currentEditingProject ? 'Edit Project' : 'Create New Project'}</h2>
                        <button class="close-btn" onclick="closeEditModal()">&times;</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project ID</label>
                        <input type="text" class="form-input" id="projectIdInput" disabled>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Title *</label>
                        <input type="text" class="form-input" id="projectTitleInput" placeholder="Enter project title">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="projectStatusSelect">
                            ${APP.statuses.length > 0 ? 
                                APP.statuses.map(s => `<option value="${s}">${s}</option>`).join('') :
                                '<option value="planning">planning</option>'}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categories ${APP.categories.length === 0 ? '(Add categories in Manage Settings)' : '*'}</label>
                        <div id="categoryCheckboxes" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            ${APP.categories.length > 0 ? 
                                APP.categories.map(cat => `
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="cat-check-${cat}" value="${cat}">
                                        ${cat}
                                    </label>
                                `).join('') :
                                '<span style="color: var(--text-secondary);">No categories available</span>'}
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Key Details</label>
                        <textarea class="form-textarea" id="projectDetailsInput" placeholder="Enter key details"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Next Steps</label>
                        <textarea class="form-textarea" id="projectNextStepsInput" placeholder="Enter next steps"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Links</label>
                        <div id="projectLinksDisplay" style="margin-bottom: 1rem;"></div>
                        <button class="btn-primary" onclick="addLink()" style="font-size: 0.875rem; padding: 0.5rem 1rem;">Add Link</button>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn-primary" onclick="closeEditModal()" style="background: var(--bg-secondary); border: 1px solid var(--border-color);">Cancel</button>
                        <button class="btn-save" onclick="saveProject()">Save Project</button>
                    </div>
                </div>
            `;
            
            updateLinksDisplay();
            return modal;
        }

        function updateLinksDisplay() {
            const container = document.getElementById('projectLinksDisplay');
            if (!container) return;
            
            if (APP.currentProjectLinks.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); font-size: 0.875rem;">No links added</div>';
            } else {
                container.innerHTML = APP.currentProjectLinks.map((link, idx) => `
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <a href="${link.url}" target="_blank" style="color: var(--accent-blue);">${link.alias}</a>
                        <button onclick="removeLink(${idx})" style="padding: 0.25rem 0.5rem; background: var(--accent-red); color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Remove</button>
                    </div>
                `).join('');
            }
        }

        function addLink() {
            const container = document.getElementById('projectLinksDisplay');
            if (!container) return;
            
            // Check if add form already exists
            if (document.getElementById('linkAddForm')) return;
            
            const formDiv = document.createElement('div');
            formDiv.id = 'linkAddForm';
            formDiv.style.cssText = 'padding: 1rem; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 1rem;';
            formDiv.innerHTML = `
                <div style="margin-bottom: 0.5rem;">
                    <input type="text" id="linkAliasInput" placeholder="Display text" style="width: 100%; padding: 0.5rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); margin-bottom: 0.5rem;">
                    <input type="url" id="linkUrlInput" placeholder="https://example.com" style="width: 100%; padding: 0.5rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary);">
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="saveLinkFromForm()" style="padding: 0.5rem 1rem; background: var(--accent-green); color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
                    <button onclick="cancelLinkForm()" style="padding: 0.5rem 1rem; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; cursor: pointer;">Cancel</button>
                </div>
            `;
            
            container.parentNode.insertBefore(formDiv, container);
        }
        
        function saveLinkFromForm() {
            const aliasInput = document.getElementById('linkAliasInput');
            const urlInput = document.getElementById('linkUrlInput');
            
            if (!aliasInput || !urlInput) return;
            
            const alias = aliasInput.value.trim();
            const url = urlInput.value.trim();
            
            if (!alias || !url) {
                showNotification('Please enter both display text and URL', 'error');
                return;
            }
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showNotification('URL must start with http:// or https://', 'error');
                return;
            }
            
            APP.currentProjectLinks.push({ alias, url });
            updateLinksDisplay();
            
            const form = document.getElementById('linkAddForm');
            if (form) form.remove();
            
            showNotification('Link added successfully', 'success');
        }
        
        function cancelLinkForm() {
            const form = document.getElementById('linkAddForm');
            if (form) form.remove();
        }

        function removeLink(index) {
            APP.currentProjectLinks.splice(index, 1);
            updateLinksDisplay();
            showNotification('Link removed', 'success');
        }

        function saveProject() {
            const id = parseInt(document.getElementById('projectIdInput').value);
            const title = document.getElementById('projectTitleInput').value.trim();
            const status = document.getElementById('projectStatusSelect').value;
            const keyDetails = document.getElementById('projectDetailsInput').value.trim();
            const nextSteps = document.getElementById('projectNextStepsInput').value.trim();
            
            const categories = [];
            document.querySelectorAll('#categoryCheckboxes input:checked').forEach(cb => {
                categories.push(cb.value);
            });
            
            if (!title) {
                showNotification('Please enter a project title', 'error');
                return;
            }
            
            if (categories.length === 0) {
                showNotification('Please select at least one category', 'error');
                return;
            }
            
            const projectData = {
                id,
                title,
                status,
                categories,
                keyDetails,
                nextSteps,
                links: APP.currentProjectLinks
            };
            
            if (APP.currentEditingProject) {
                const index = APP.projects.findIndex(p => p.id === APP.currentEditingProject);
                if (index !== -1) {
                    APP.projects[index] = projectData;
                    showNotification('Project updated successfully', 'success');
                }
            } else {
                APP.projects.push(projectData);
                showNotification('Project created successfully', 'success');
            }
            
            // Update last updated timestamp
            const now = new Date();
            APP.lastUpdated = now.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('lastUpdatedText').textContent = `Last Updated: ${APP.lastUpdated}`;
            
            saveToLocalStorage();
            updateStats();
            renderProjects();
            closeEditModal();
        }

        function closeEditModal() {
            const modal = document.getElementById('editModal');
            if (modal) modal.remove();
        }

        function openProjectModal(id) {
            const project = APP.projects.find(p => p.id === id);
            if (!project) return;
            
            const modal = document.createElement('div');
            modal.id = 'projectModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>${project.title}</h2>
                        <button class="close-btn" onclick="closeProjectModal()">&times;</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project ID</label>
                        <div>${project.id}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <div><span style="background: var(--accent-blue); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem;">${project.status}</span></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categories</label>
                        <div>${project.categories ? project.categories.join(', ') : 'None'}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Key Details</label>
                        <div style="white-space: pre-wrap;">${project.keyDetails || 'No details provided'}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Next Steps</label>
                        <div style="white-space: pre-wrap;">${project.nextSteps || 'No next steps defined'}</div>
                    </div>
                    ${project.links && project.links.length > 0 ? `
                        <div class="form-group">
                            <label class="form-label">Links</label>
                            <div>
                                ${project.links.map(link => 
                                    `<div style="margin-bottom: 0.5rem;"><a href="${link.url}" target="_blank" style="color: var(--accent-blue);">${link.alias}</a></div>`
                                ).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
        }

        function closeProjectModal() {
            const modal = document.getElementById('projectModal');
            if (modal) modal.remove();
        }

        function openManageModal() {
            const modal = document.createElement('div');
            modal.id = 'manageModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Manage Settings</h2>
                        <button class="close-btn" onclick="closeManageModal()">&times;</button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Categories</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="text" class="form-input" id="newCategoryInput" placeholder="Enter category name" style="flex: 1;">
                            <button class="btn-save" onclick="addCategory()">Add</button>
                        </div>
                        <div id="categoriesList">
                            ${APP.categories.map((cat, idx) => `
                                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 0.5rem;">
                                    <input type="text" id="cat-edit-${idx}" value="${cat}" style="flex: 1; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.25rem 0.5rem; color: var(--text-primary);">
                                    <button onclick="updateCategory(${idx})" style="padding: 0.25rem 0.5rem; background: var(--accent-blue); color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Update</button>
                                    <button onclick="deleteCategory('${cat.replace(/'/g, "\\'")}')" style="padding: 0.25rem 0.5rem; background: var(--accent-red); color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Delete</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Statuses</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="text" class="form-input" id="newStatusInput" placeholder="Enter status name" style="flex: 1;">
                            <button class="btn-save" onclick="addStatus()">Add</button>
                        </div>
                        <div id="statusesList">
                            ${APP.statuses.map((status, idx) => `
                                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 0.5rem;">
                                    <input type="text" id="status-edit-${idx}" value="${status}" style="flex: 1; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.25rem 0.5rem; color: var(--text-primary);">
                                    <button onclick="updateStatus(${idx})" style="padding: 0.25rem 0.5rem; background: var(--accent-blue); color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Update</button>
                                    <button onclick="deleteStatus('${status}')" style="padding: 0.25rem 0.5rem; background: var(--accent-red); color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Delete</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
        }

        function closeManageModal() {
            const modal = document.getElementById('manageModal');
            if (modal) modal.remove();
        }

        function addCategory() {
            const input = document.getElementById('newCategoryInput');
            const category = input.value.trim();
            
            if (!category) {
                showNotification('Please enter a category name', 'error');
                return;
            }
            
            if (APP.categories.includes(category)) {
                showNotification('This category already exists', 'error');
                return;
            }
            
            APP.categories.push(category);
            saveToLocalStorage();
            updateFilterDropdowns();
            closeManageModal();
            setTimeout(() => openManageModal(), 100);
            showNotification('Category added successfully', 'success');
        }

        function deleteCategory(category) {
            showConfirm(`Delete category "${category}"? This will remove it from all projects.`, function() {
                APP.categories = APP.categories.filter(c => c !== category);
                APP.projects.forEach(p => {
                    if (p.categories) {
                        p.categories = p.categories.filter(c => c !== category);
                    }
                });
                saveToLocalStorage();
                updateFilterDropdowns();
                renderProjects();
                closeManageModal();
                setTimeout(() => openManageModal(), 100);
                showNotification('Category deleted successfully', 'success');
            });
        }

        function addStatus() {
            const input = document.getElementById('newStatusInput');
            const status = input.value.trim().toLowerCase().replace(/\s+/g, '-');
            
            if (!status) {
                showNotification('Please enter a status name', 'error');
                return;
            }
            
            if (APP.statuses.includes(status)) {
                showNotification('This status already exists', 'error');
                return;
            }
            
            APP.statuses.push(status);
            saveToLocalStorage();
            updateFilterDropdowns();
            closeManageModal();
            setTimeout(() => openManageModal(), 100);
            showNotification('Status added successfully', 'success');
        }

        function deleteStatus(status) {
            showConfirm(`Delete status "${status}"? Projects with this status will be set to "planning".`, function() {
                APP.statuses = APP.statuses.filter(s => s !== status);
                APP.projects.forEach(p => {
                    if (p.status === status) p.status = 'planning';
                });
                saveToLocalStorage();
                updateFilterDropdowns();
                renderProjects();
                closeManageModal();
                setTimeout(() => openManageModal(), 100);
                showNotification('Status deleted successfully', 'success');
            });
        }

        // Update category name
        function updateCategory(index) {
            const input = document.getElementById(`cat-edit-${index}`);
            if (!input) return;
            
            const oldCategory = APP.categories[index];
            const newCategory = input.value.trim();
            
            if (!newCategory) {
                showNotification('Category name cannot be empty', 'error');
                return;
            }
            
            if (newCategory === oldCategory) {
                return; // No change
            }
            
            if (APP.categories.includes(newCategory)) {
                showNotification('This category name already exists', 'error');
                return;
            }
            
            // Update category in the categories array
            APP.categories[index] = newCategory;
            
            // Update category in all projects that have it
            APP.projects.forEach(project => {
                if (project.categories && project.categories.includes(oldCategory)) {
                    const catIndex = project.categories.indexOf(oldCategory);
                    project.categories[catIndex] = newCategory;
                }
            });
            
            // Update selected categories filter if it was selected
            if (APP.selectedCategories.includes(oldCategory)) {
                const selectedIndex = APP.selectedCategories.indexOf(oldCategory);
                APP.selectedCategories[selectedIndex] = newCategory;
            }
            
            saveToLocalStorage();
            updateFilterDropdowns();
            renderProjects();
            closeManageModal();
            setTimeout(() => openManageModal(), 100);
            showNotification(`Category updated from "${oldCategory}" to "${newCategory}"`, 'success');
        }

        // Update status name
        function updateStatus(index) {
            const input = document.getElementById(`status-edit-${index}`);
            if (!input) return;
            
            const oldStatus = APP.statuses[index];
            const newStatus = input.value.trim().toLowerCase().replace(/\s+/g, '-');
            
            if (!newStatus) {
                showNotification('Status name cannot be empty', 'error');
                return;
            }
            
            if (newStatus === oldStatus) {
                return; // No change
            }
            
            if (APP.statuses.includes(newStatus)) {
                showNotification('This status name already exists', 'error');
                return;
            }
            
            // Update status in the statuses array
            APP.statuses[index] = newStatus;
            
            // Update status in all projects that have it
            APP.projects.forEach(project => {
                if (project.status === oldStatus) {
                    project.status = newStatus;
                }
            });
            
            // Update selected statuses filter if it was selected
            if (APP.selectedStatuses.includes(oldStatus)) {
                const selectedIndex = APP.selectedStatuses.indexOf(oldStatus);
                APP.selectedStatuses[selectedIndex] = newStatus;
            }
            
            saveToLocalStorage();
            updateFilterDropdowns();
            renderProjects();
            closeManageModal();
            setTimeout(() => openManageModal(), 100);
            showNotification(`Status updated from "${oldStatus}" to "${newStatus}"`, 'success');
        }

        // Export function
        function exportPKD() {
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            let content = `**Project Knowledge Document**\n\n`;
            content += `*Last Updated: ${dateStr}*\n\n`;
            content += `**Quick Reference List**\n\n`;
            
            APP.projects.forEach((project, index) => {
                content += `${index + 1}.  ${project.title}\n\n`;
            });
            
            content += `**Active Projects**\n\n`;
            
            APP.projects.forEach(project => {
                content += `**${project.id}. ${project.title}**\n\n`;
                content += `-   **Status**: ${project.status}\n\n`;
                content += `-   **Project Category**: ${project.categories ? project.categories.join(', ') : ''}\n\n`;
                content += `-   **Key Details**: ${project.keyDetails || ''}\n\n`;
                content += `-   **Next Steps**: ${project.nextSteps || ''}\n\n`;
                
                if (project.links && project.links.length > 0) {
                    content += `-   **Links**: `;
                    project.links.forEach((link, idx) => {
                        if (idx > 0) content += ', ';
                        content += `[${link.alias}](${link.url})`;
                    });
                    content += '\n\n';
                }
            });
            
            content += `**Weekly Review Checklist**\n\n`;
            content += `-   [ ] Update project statuses\n\n`;
            content += `-   [ ] Review blockers and dependencies\n\n`;
            content += `-   [ ] Check upcoming deadlines\n\n`;
            content += `-   [ ] Update team member progress\n\n`;
            content += `-   [ ] Document completed milestones\n\n`;
            content += `-   [ ] Plan next week's priorities\n\n`;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `PKD_${today.getFullYear()}_${(today.getMonth() + 1).toString().padStart(2, '0')}_${today.getDate().toString().padStart(2, '0')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            APP.lastUpdated = dateStr;
            document.getElementById('lastUpdatedText').textContent = `Last Updated: ${APP.lastUpdated}`;
            saveToLocalStorage();
            showNotification('PKD exported successfully', 'success');
        }

        // Parse PKD content
        function parsePKDContent(content) {
            const result = {
                projects: [],
                categories: [],
                statuses: [],
                lastUpdated: 'Never'
            };
            
            // Use Set to collect unique values
            const categoriesSet = new Set();
            const statusesSet = new Set();
            
            const lines = content.split('\n');
            
            // Find last updated date
            for (let i = 0; i < Math.min(lines.length, 10); i++) {
                const line = lines[i];
                if (line.includes('Last Updated:')) {
                    const match = line.match(/\*Last Updated:\s*(.+?)\*/);
                    if (match) {
                        result.lastUpdated = match[1].trim();
                        break;
                    }
                }
            }
            
            // Find projects section
            const projectsStart = lines.findIndex(line => line.includes('**Active Projects**'));
            if (projectsStart === -1) {
                console.log('No Active Projects section found');
                return result;
            }
            
            let currentProject = null;
            
            for (let i = projectsStart + 1; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                
                // New project
                const projectMatch = trimmedLine.match(/^\*\*(\d+)\.\s+(.+)\*\*$/);
                if (projectMatch) {
                    if (currentProject) {
                        result.projects.push(currentProject);
                    }
                    currentProject = {
                        id: parseInt(projectMatch[1]),
                        title: projectMatch[2],
                        status: 'planning',
                        categories: [],
                        keyDetails: '',
                        nextSteps: '',
                        links: []
                    };
                    console.log(`Found project: ${currentProject.title}`);
                    continue;
                }
                
                if (!currentProject) continue;
                
                // Status
                if (line.includes('**Status**:')) {
                    const parts = line.split('**Status**:');
                    if (parts.length > 1) {
                        const status = parts[1].trim().toLowerCase().replace(/\s+/g, '-');
                        currentProject.status = status;
                        statusesSet.add(status);
                        console.log(`  Status: ${status}`);
                    }
                }
                
                // Project Category
                if (line.includes('**Project Category**:')) {
                    const parts = line.split('**Project Category**:');
                    if (parts.length > 1) {
                        const cats = parts[1].trim();
                        if (cats) {
                            // Split by comma and clean each category
                            const categoryList = cats.split(',').map(c => c.trim()).filter(c => c);
                            currentProject.categories = categoryList;
                            categoryList.forEach(c => {
                                categoriesSet.add(c);
                            });
                            console.log(`  Categories for ${currentProject.title}: [${categoryList.join(', ')}]`);
                        }
                    }
                }
                
                // Key Details
                if (line.includes('**Key Details**:')) {
                    const parts = line.split('**Key Details**:');
                    if (parts.length > 1) {
                        currentProject.keyDetails = parts[1].trim();
                    }
                }
                
                // Next Steps  
                if (line.includes('**Next Steps**:')) {
                    const parts = line.split('**Next Steps**:');
                    if (parts.length > 1) {
                        currentProject.nextSteps = parts[1].trim();
                    }
                }
                
                // Links
                if (line.includes('**Links**:')) {
                    const parts = line.split('**Links**:');
                    if (parts.length > 1) {
                        const linksText = parts[1].trim();
                        const linkMatches = [...linksText.matchAll(/\[([^\]]+)\]\(([^)]+)\)/g)];
                        linkMatches.forEach(match => {
                            currentProject.links.push({ alias: match[1], url: match[2] });
                        });
                    }
                }
                
                // End of projects
                if (line.includes('**Weekly Review Checklist**')) {
                    if (currentProject) {
                        result.projects.push(currentProject);
                    }
                    break;
                }
            }
            
            // Add last project if not already added
            if (currentProject && !result.projects.find(p => p.id === currentProject.id)) {
                result.projects.push(currentProject);
            }
            
            // Convert Sets to Arrays
            result.categories = Array.from(categoriesSet).sort();
            result.statuses = Array.from(statusesSet).sort();
            
            console.log('=== PARSING COMPLETE ===');
            console.log('Unique categories found:', result.categories);
            console.log('Unique statuses found:', result.statuses);
            console.log('Total projects:', result.projects.length);
            
            // Log first few projects with their categories for debugging
            result.projects.slice(0, 5).forEach(p => {
                console.log(`Project "${p.title}" (ID: ${p.id})`);
                console.log(`  Categories: [${p.categories.join(', ')}]`);
                console.log(`  Status: ${p.status}`);
            });
            
            return result;
        }

        // File upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const parsed = parsePKDContent(content);
                    
                    console.log('Parsed data:', parsed);
                    
                    if (parsed.lastUpdated) {
                        APP.lastUpdated = parsed.lastUpdated;
                        document.getElementById('lastUpdatedText').textContent = `Last Updated: ${APP.lastUpdated}`;
                    }
                    
                    if (parsed.projects.length > 0) {
                        // Replace all data with parsed data
                        APP.projects = parsed.projects;
                        APP.categories = parsed.categories;
                        APP.statuses = parsed.statuses;
                        
                        // Log for debugging
                        console.log('Projects loaded:', APP.projects);
                        console.log('Categories loaded:', APP.categories);
                        console.log('Statuses loaded:', APP.statuses);
                        
                        // Check that projects have their categories
                        APP.projects.forEach(p => {
                            console.log(`Project ${p.id} (${p.title}) has categories:`, p.categories);
                        });
                        
                        saveToLocalStorage();
                        updateStats();
                        updateFilterDropdowns();
                        renderProjects();
                        
                        showNotification(`Loaded ${APP.projects.length} projects with ${APP.categories.length} categories`, 'success');
                    } else {
                        showNotification('No projects found in file', 'error');
                    }
                } catch (error) {
                    console.error('Parse error:', error);
                    showNotification('Error parsing file', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkPassword();
                    }
                });
                passwordInput.focus();
            }
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown-filter')) {
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        menu.classList.remove('open');
                    });
                }
            });
            
            // Close modals on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modals = document.querySelectorAll('.modal');
                    modals.forEach(modal => modal.remove());
                }
            });
        });
    </script>
</body>
</html>
